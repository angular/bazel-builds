/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __values = (this && this.__values) || function (o) {
    var m = typeof Symbol === "function" && o[Symbol.iterator], i = 0;
    if (m) return m.call(o);
    return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("angular/packages/bazel/src/ng_package/packager", ["require", "exports", "fs", "path", "shelljs"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var fs = require("fs");
    var path = require("path");
    var shx = require("shelljs");
    function main(args) {
        var e_1, _a;
        // Exit immediately when encountering an error.
        shx.set('-e');
        // Keep track of whether an error has occured so that we can return an appropriate exit code.
        var errorHasOccured = false;
        // This utility expects all of its arguments to be specified in a params file generated by
        // bazel (see https://docs.bazel.build/versions/master/skylark/lib/Args.html#use_param_file).
        var paramFilePath = args[0];
        // Bazel params may be surrounded with quotes
        function unquoteParameter(s) { return s.replace(/^'(.*)'$/, '$1'); }
        // Parameters are specified in the file one per line.
        var params = fs.readFileSync(paramFilePath, 'utf-8').split('\n').map(unquoteParameter);
        var _b = __read(params, 14), 
        // Output directory for the npm package.
        out = _b[0], 
        // The package segment of the ng_package rule's label (e.g. 'package/common').
        srcDir = _b[1], 
        // The bazel-bin dir joined with the srcDir (e.g. 'bazel-bin/package.common').
        // This is the intended output location for package artifacts.
        binDir = _b[2], 
        // The bazel-genfiles dir joined with the srcDir (e.g. 'bazel-bin/package.common').
        genfilesDir = _b[3], 
        // JSON data mapping each entry point to the generated bundle index and
        // flat module metadata, for example
        // {"@angular/core": {
        //     "index": "bazel-bin/packages/core/core.js",
        //     "typing": "bazel-bin/packages/core/core.d.ts",
        //     "metadata": "bazel-bin/packages/core/core.metadata.json"
        //  },
        // ...
        // }
        modulesManifestArg = _b[4], 
        // Path to the package's README.md.
        readmeMd = _b[5], 
        // List of rolled-up flat ES2015 modules
        fesm2015Arg = _b[6], 
        // List of rolled-up flat ES5 modules
        fesm5Arg = _b[7], 
        // List of individual ES2015 modules
        esm2015Arg = _b[8], 
        // List of individual ES5 modules
        esm5Arg = _b[9], 
        // List of all UMD bundles generated by rollup.
        bundlesArg = _b[10], 
        // List of all files in the ng_package rule's srcs.
        srcsArg = _b[11], 
        // List of all files in the ng_package rule's data.
        dataArg = _b[12], 
        // Path to the package's LICENSE.
        licenseFile = _b[13];
        var fesm2015 = fesm2015Arg.split(',').filter(function (s) { return !!s; });
        var fesm5 = fesm5Arg.split(',').filter(function (s) { return !!s; });
        var esm2015 = esm2015Arg.split(',').filter(function (s) { return !!s; });
        var esm5 = esm5Arg.split(',').filter(function (s) { return !!s; });
        var bundles = bundlesArg.split(',').filter(function (s) { return !!s; });
        var srcs = srcsArg.split(',').filter(function (s) { return !!s; });
        var dataFiles = dataArg.split(',').filter(function (s) { return !!s; });
        var modulesManifest = JSON.parse(modulesManifestArg);
        if (readmeMd) {
            copyFile(readmeMd, out);
        }
        /**
         * Writes a file into the package based on its input path, relativizing to the package path.
         * @param inputPath Path to the file in the input tree.
         * @param fileContent Content of the file.
         */
        function writeFileFromInputPath(inputPath, fileContent) {
            // We want the relative path from the given file to its ancestor "root" directory.
            // This root depends on whether the file lives in the source tree (srcDir) as a basic file
            // input to ng_package, the bin output tree (binDir) as the output of another rule, or
            // the genfiles output tree (genfilesDir) as the output of a genrule.
            var rootDir;
            if (inputPath.includes(binDir)) {
                rootDir = binDir;
            }
            else if (inputPath.includes(genfilesDir)) {
                rootDir = genfilesDir;
            }
            else {
                rootDir = srcDir;
            }
            var outputPath = path.join(out, path.relative(rootDir, inputPath));
            // Always ensure that the target directory exists.
            shx.mkdir('-p', path.dirname(outputPath));
            fs.writeFileSync(outputPath, fileContent, 'utf-8');
        }
        /**
         * Copies a file into the package based on its input path, relativizing to the package path.
         * @param inputPath a path relative to the binDir, typically from a file in the deps[]
         */
        function copyFileFromInputPath(inputPath) {
            writeFileFromInputPath(inputPath, fs.readFileSync(inputPath, 'utf-8'));
        }
        /**
         * Relativize the path where a file is written.
         * @param file a path containing a re-rooted segment like .esm5 or .es6
         * @param suffix the re-rooted directory
         * @param outDir path where we copy the file, relative to the out
         */
        function writeEsmFile(file, suffix, outDir) {
            var root = file.substr(0, file.lastIndexOf(suffix + path.sep) + suffix.length + 1);
            var rel = path.dirname(path.relative(path.join(root, srcDir), file));
            if (!rel.startsWith('..')) {
                copyFile(file, path.join(out, outDir), rel);
            }
        }
        esm2015.forEach(function (file) { return writeEsmFile(file, '.es6', 'esm2015'); });
        esm5.forEach(function (file) { return writeEsmFile(file, '.esm5', 'esm5'); });
        bundles.forEach(function (bundle) { copyFile(bundle, out, 'bundles'); });
        fesm2015.forEach(function (file) { copyFile(file, out, 'fesm2015'); });
        fesm5.forEach(function (file) { copyFile(file, out, 'fesm5'); });
        var allsrcs = shx.find('-R', binDir);
        allsrcs.filter(hasFileExtension('.d.ts')).forEach(function (f) {
            var content = fs.readFileSync(f, 'utf-8')
                // Strip the named AMD module for compatibility with non-bazel users
                .replace(/^\/\/\/ <amd-module name=.*\/>\n/gm, '');
            writeFileFromInputPath(f, content);
        });
        // Copy all `data` files into the package. These are files that aren't built by the ng_package
        // rule, but instead are just straight copied into the package, e.g. global CSS assets.
        dataFiles.forEach(function (f) { return copyFileFromInputPath(f); });
        // Iterate through the entry point modules
        // We do this first because we also record new paths for the esm5 and esm2015 copies
        // of the index JS file, which we need to amend the package.json.
        Object.keys(modulesManifest).forEach(function (moduleName) {
            var moduleFiles = modulesManifest[moduleName];
            var relative = path.relative(binDir, moduleFiles['index']);
            moduleFiles['esm5_index'] = path.join(binDir, 'esm5', relative);
            moduleFiles['esm2015_index'] = path.join(binDir, 'esm2015', relative);
            copyFileFromInputPath(moduleFiles['metadata']);
        });
        // Root package name (e.g. '@angular/common'), captures as we iterate through sources below.
        var rootPackageName = '';
        var packagesWithExistingPackageJson = new Set();
        try {
            for (var srcs_1 = __values(srcs), srcs_1_1 = srcs_1.next(); !srcs_1_1.done; srcs_1_1 = srcs_1.next()) {
                var src = srcs_1_1.value;
                if (src.includes(binDir) || src.includes(genfilesDir)) {
                    errorHasOccured = true;
                    console.error('The "srcs" for ng_package should not include output of other rules. Found:\n' +
                        ("  " + src));
                }
                var content = fs.readFileSync(src, 'utf-8');
                // Modify package.json files as necessary for publishing
                if (path.basename(src) === 'package.json') {
                    var packageJson = JSON.parse(content);
                    content = amendPackageJson(src, packageJson);
                    var packageName = packageJson['name'];
                    packagesWithExistingPackageJson.add(packageName);
                    // Keep track of the root package name, e.g. "@angular/common". We assume that the
                    // root name will be shortest because secondary entry-points will append to it
                    // (e.g. "@angular/common/http").
                    if (!rootPackageName || packageName.length < rootPackageName.length) {
                        rootPackageName = packageJson['name'];
                    }
                }
                writeFileFromInputPath(src, content);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (srcs_1_1 && !srcs_1_1.done && (_a = srcs_1.return)) _a.call(srcs_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        var licenseBanner = licenseFile ? fs.readFileSync(licenseFile, 'utf-8') : '';
        // Generate extra files for secondary entry-points.
        Object.keys(modulesManifest).forEach(function (entryPointPackageName) {
            var entryPointName = entryPointPackageName.substr(rootPackageName.length + 1);
            if (!entryPointName)
                return;
            createMetadataReexportFile(entryPointName, modulesManifest[entryPointPackageName]['metadata'], entryPointPackageName);
            createTypingsReexportFile(entryPointName, licenseBanner, modulesManifest[entryPointPackageName]['typings']);
            if (!packagesWithExistingPackageJson.has(entryPointPackageName)) {
                createEntryPointPackageJson(entryPointName, entryPointPackageName);
            }
        });
        return errorHasOccured ? 1 : 0;
        /**
         * Convert a binDir-relative path to srcDir-relative
         * @param from path to a file under the srcDir, like packages/core/testing/package.json
         * @param file path to a file under the binDir, like bazel-bin/core/testing/generated.js
         */
        function srcDirRelative(from, file) {
            var result = path.relative(path.dirname(from), path.join(srcDir, path.relative(binDir, file)));
            if (result.startsWith('..'))
                return result;
            return "./" + result;
        }
        /** Gets a predicate function to filter non-generated files with a specified extension. */
        function hasFileExtension(ext) {
            return function (f) { return f.endsWith(ext) && !f.endsWith(".ngfactory" + ext) &&
                !f.endsWith(".ngsummary" + ext); };
        }
        function copyFile(file, baseDir, relative) {
            if (relative === void 0) { relative = '.'; }
            var dir = path.join(baseDir, relative);
            shx.mkdir('-p', dir);
            shx.cp(file, dir);
            // Double-underscore is used to escape forward slash in FESM filenames.
            // See ng_package.bzl:
            //   fesm_output_filename = entry_point.replace("/", "__")
            // We need to unescape these.
            if (file.indexOf('__') >= 0) {
                var outputPath = path.join.apply(path, __spread([dir], path.basename(file).split('__')));
                shx.mkdir('-p', path.dirname(outputPath));
                shx.mv(path.join(dir, path.basename(file)), outputPath);
            }
        }
        /**
         * Inserts or edits properties into the package.json file(s) in the package so that
         * they point to all the right generated artifacts.
         *
         * @param packageJson The path to the package.json file.
         * @param parsedPackage Parsed package.json content
         */
        function amendPackageJson(packageJson, parsedPackage) {
            var packageName = parsedPackage['name'];
            var moduleFiles = modulesManifest[packageName];
            if (!moduleFiles) {
                // Ideally we should throw here, as we got an entry point that doesn't
                // have flat module metadata / bundle index, so it may have been an
                // ng_module that's missing a module_name attribute.
                // However, @angular/compiler can't be an ng_module, as it's the internals
                // of the ngc compiler, yet we want to build an ng_package for it.
                // So ignore package.json files when we are missing data.
                console.error('WARNING: no module metadata for package', packageName);
                console.error('   Not updating the package.json file to point to it');
                console.error('   The ng_module for this package is possibly missing the module_name attribute ');
                return JSON.stringify(parsedPackage, null, 2);
            }
            // Derive the paths to the files from the hard-coded names we gave them.
            // TODO(alexeagle): it would be better to transfer this information from the place
            // where we created the filenames, via the modulesManifestArg
            parsedPackage['main'] = getBundleName(packageName, 'bundles');
            parsedPackage['fesm5'] = getBundleName(packageName, 'fesm5');
            parsedPackage['fesm2015'] = getBundleName(packageName, 'fesm2015');
            parsedPackage['esm5'] = srcDirRelative(packageJson, moduleFiles['esm5_index']);
            parsedPackage['esm2015'] = srcDirRelative(packageJson, moduleFiles['esm2015_index']);
            parsedPackage['typings'] = srcDirRelative(packageJson, moduleFiles['typings']);
            // For now, we point the primary entry points at the fesm files, because of Webpack
            // performance issues with a large number of individual files.
            // TODO(iminar): resolve performance issues with the toolchain and point these to esm
            parsedPackage['module'] = parsedPackage['fesm5'];
            parsedPackage['es2015'] = parsedPackage['fesm2015'];
            return JSON.stringify(parsedPackage, null, 2);
        }
        // e.g. @angular/common/http/testing -> ../../bundles/common-http-testing.umd.js
        // or   @angular/common/http/testing -> ../../fesm5/http/testing.js
        function getBundleName(packageName, dir) {
            var parts = packageName.split('/');
            // Remove the scoped package part, like @angular if present
            var nameParts = packageName.startsWith('@') ? parts.splice(1) : parts;
            var relativePath = Array(nameParts.length - 1).fill('..').join('/') || '.';
            var basename;
            if (dir === 'bundles') {
                basename = nameParts.join('-') + '.umd';
            }
            else if (nameParts.length === 1) {
                basename = nameParts[0];
            }
            else {
                basename = nameParts.slice(1).join('/');
            }
            return [relativePath, dir, basename + '.js'].join('/');
        }
        /** Creates metadata re-export file for a secondary entry-point. */
        function createMetadataReexportFile(entryPointName, metadataFile, packageName) {
            var inputPath = path.join(srcDir, entryPointName + ".metadata.json");
            writeFileFromInputPath(inputPath, JSON.stringify({
                '__symbolic': 'module',
                'version': 3,
                'metadata': {},
                'exports': [{ 'from': "" + srcDirRelative(inputPath, metadataFile.replace(/.metadata.json$/, '')) }],
                'flatModuleIndexRedirect': true,
                'importAs': packageName
            }) + '\n');
        }
        /**
         * Creates a typings (d.ts) re-export file for a secondary-entry point,
         * e.g., `export * from './common/common'`
         */
        function createTypingsReexportFile(entryPointName, license, typingsFile) {
            var inputPath = path.join(srcDir, entryPointName + ".d.ts");
            var content = license + "\n  export * from '" + srcDirRelative(inputPath, typingsFile.replace(/\.d\.tsx?$/, '')) + "';\n  ";
            writeFileFromInputPath(inputPath, content);
        }
        /**
         * Creates a package.json for a secondary entry-point.
         * @param dir The directory under which the package.json should be written.
         * @param entryPointPackageName The full package name for the entry point,
         *     e.g. '@angular/common/http'.
         */
        function createEntryPointPackageJson(dir, entryPointPackageName) {
            var pkgJson = path.join(srcDir, dir, 'package.json');
            var content = amendPackageJson(pkgJson, { name: entryPointPackageName });
            writeFileFromInputPath(pkgJson, content);
        }
    }
    if (require.main === module) {
        process.exitCode = main(process.argv.slice(2));
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC9zcmMvbmdfcGFja2FnZS9wYWNrYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUVILHVCQUF5QjtJQUN6QiwyQkFBNkI7SUFDN0IsNkJBQStCO0lBRS9CLFNBQVMsSUFBSSxDQUFDLElBQWM7O1FBQzFCLCtDQUErQztRQUMvQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWQsNkZBQTZGO1FBQzdGLElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQztRQUU1QiwwRkFBMEY7UUFDMUYsNkZBQTZGO1FBQzdGLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU5Qiw2Q0FBNkM7UUFDN0MsU0FBUyxnQkFBZ0IsQ0FBQyxDQUFTLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFNUUscURBQXFEO1FBQ3JELElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUVuRixJQUFBLHVCQW1ESTtRQWxETix3Q0FBd0M7UUFDeEMsV0FBRztRQUVILDhFQUE4RTtRQUM5RSxjQUFNO1FBRU4sOEVBQThFO1FBQzlFLDhEQUE4RDtRQUM5RCxjQUFNO1FBRU4sbUZBQW1GO1FBQ25GLG1CQUFXO1FBRVgsdUVBQXVFO1FBQ3ZFLG9DQUFvQztRQUNwQyxzQkFBc0I7UUFDdEIsa0RBQWtEO1FBQ2xELHFEQUFxRDtRQUNyRCwrREFBK0Q7UUFDL0QsTUFBTTtRQUNOLE1BQU07UUFDTixJQUFJO1FBQ0osMEJBQWtCO1FBRWxCLG1DQUFtQztRQUNuQyxnQkFBUTtRQUVSLHdDQUF3QztRQUN4QyxtQkFBVztRQUVYLHFDQUFxQztRQUNyQyxnQkFBUTtRQUVSLG9DQUFvQztRQUNwQyxrQkFBVTtRQUVWLGlDQUFpQztRQUNqQyxlQUFPO1FBRVAsK0NBQStDO1FBQy9DLG1CQUFVO1FBRVYsbURBQW1EO1FBQ25ELGdCQUFPO1FBRVAsbURBQW1EO1FBQ25ELGdCQUFPO1FBRVAsaUNBQWlDO1FBQ2pDLG9CQUNNLENBQUM7UUFFWCxJQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxDQUFDLEVBQUgsQ0FBRyxDQUFDLENBQUM7UUFDekQsSUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsQ0FBQyxFQUFILENBQUcsQ0FBQyxDQUFDO1FBQ25ELElBQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLENBQUMsRUFBSCxDQUFHLENBQUMsQ0FBQztRQUN2RCxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxDQUFDLEVBQUgsQ0FBRyxDQUFDLENBQUM7UUFDakQsSUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsQ0FBQyxFQUFILENBQUcsQ0FBQyxDQUFDO1FBQ3ZELElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLENBQUMsRUFBSCxDQUFHLENBQUMsQ0FBQztRQUNqRCxJQUFNLFNBQVMsR0FBYSxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxDQUFDLEVBQUgsQ0FBRyxDQUFDLENBQUM7UUFDaEUsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBRXZELElBQUksUUFBUSxFQUFFO1lBQ1osUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUN6QjtRQUVEOzs7O1dBSUc7UUFDSCxTQUFTLHNCQUFzQixDQUFDLFNBQWlCLEVBQUUsV0FBbUI7WUFDcEUsa0ZBQWtGO1lBQ2xGLDBGQUEwRjtZQUMxRixzRkFBc0Y7WUFDdEYscUVBQXFFO1lBQ3JFLElBQUksT0FBZSxDQUFDO1lBQ3BCLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxHQUFHLE1BQU0sQ0FBQzthQUNsQjtpQkFBTSxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQzFDLE9BQU8sR0FBRyxXQUFXLENBQUM7YUFDdkI7aUJBQU07Z0JBQ0wsT0FBTyxHQUFHLE1BQU0sQ0FBQzthQUNsQjtZQUVELElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFFckUsa0RBQWtEO1lBQ2xELEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUMxQyxFQUFFLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDckQsQ0FBQztRQUVEOzs7V0FHRztRQUNILFNBQVMscUJBQXFCLENBQUMsU0FBaUI7WUFDOUMsc0JBQXNCLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDekUsQ0FBQztRQUVEOzs7OztXQUtHO1FBQ0gsU0FBUyxZQUFZLENBQUMsSUFBWSxFQUFFLE1BQWMsRUFBRSxNQUFjO1lBQ2hFLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3JGLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3ZFLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN6QixRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2FBQzdDO1FBQ0gsQ0FBQztRQUVELE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxZQUFZLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsRUFBckMsQ0FBcUMsQ0FBQyxDQUFDO1FBQy9ELElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxZQUFZLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsRUFBbkMsQ0FBbUMsQ0FBQyxDQUFDO1FBRTFELE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQSxNQUFNLElBQU0sUUFBUSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqRSxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQUEsSUFBSSxJQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUksSUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpELElBQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxDQUFTO1lBQzFELElBQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQztnQkFDdkIsb0VBQW9FO2lCQUNuRSxPQUFPLENBQUMsb0NBQW9DLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDdkUsc0JBQXNCLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUgsOEZBQThGO1FBQzlGLHVGQUF1RjtRQUN2RixTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEVBQXhCLENBQXdCLENBQUMsQ0FBQztRQUVqRCwwQ0FBMEM7UUFDMUMsb0ZBQW9GO1FBQ3BGLGlFQUFpRTtRQUNqRSxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLFVBQVU7WUFDN0MsSUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2hELElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBRTdELFdBQVcsQ0FBQyxZQUFZLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDaEUsV0FBVyxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUV0RSxxQkFBcUIsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztRQUVILDRGQUE0RjtRQUM1RixJQUFJLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDekIsSUFBTSwrQkFBK0IsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDOztZQUUxRCxLQUFrQixJQUFBLFNBQUEsU0FBQSxJQUFJLENBQUEsMEJBQUEsNENBQUU7Z0JBQW5CLElBQU0sR0FBRyxpQkFBQTtnQkFDWixJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRTtvQkFDckQsZUFBZSxHQUFHLElBQUksQ0FBQztvQkFDdkIsT0FBTyxDQUFDLEtBQUssQ0FDVCw4RUFBOEU7eUJBQzlFLE9BQUssR0FBSyxDQUFBLENBQUMsQ0FBQztpQkFDakI7Z0JBRUQsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQzVDLHdEQUF3RDtnQkFDeEQsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLGNBQWMsRUFBRTtvQkFDekMsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDeEMsT0FBTyxHQUFHLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztvQkFFN0MsSUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUN4QywrQkFBK0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBRWpELGtGQUFrRjtvQkFDbEYsOEVBQThFO29CQUM5RSxpQ0FBaUM7b0JBQ2pDLElBQUksQ0FBQyxlQUFlLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsTUFBTSxFQUFFO3dCQUNuRSxlQUFlLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3FCQUN2QztpQkFDRjtnQkFDRCxzQkFBc0IsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDdEM7Ozs7Ozs7OztRQUVELElBQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUUvRSxtREFBbUQ7UUFDbkQsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxxQkFBcUI7WUFDeEQsSUFBTSxjQUFjLEdBQUcscUJBQXFCLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDaEYsSUFBSSxDQUFDLGNBQWM7Z0JBQUUsT0FBTztZQUU1QiwwQkFBMEIsQ0FDdEIsY0FBYyxFQUFFLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxFQUFFLHFCQUFxQixDQUFDLENBQUM7WUFDL0YseUJBQXlCLENBQ3JCLGNBQWMsRUFBRSxhQUFhLEVBQUUsZUFBZSxDQUFDLHFCQUFxQixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUV0RixJQUFJLENBQUMsK0JBQStCLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLEVBQUU7Z0JBQy9ELDJCQUEyQixDQUFDLGNBQWMsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO2FBQ3BFO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFL0I7Ozs7V0FJRztRQUNILFNBQVMsY0FBYyxDQUFDLElBQVksRUFBRSxJQUFZO1lBQ2hELElBQU0sTUFBTSxHQUNSLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEYsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztnQkFBRSxPQUFPLE1BQU0sQ0FBQztZQUMzQyxPQUFPLE9BQUssTUFBUSxDQUFDO1FBQ3ZCLENBQUM7UUFFRCwwRkFBMEY7UUFDMUYsU0FBUyxnQkFBZ0IsQ0FBQyxHQUFXO1lBQ25DLE9BQU8sVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxlQUFhLEdBQUssQ0FBQztnQkFDMUQsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLGVBQWEsR0FBSyxDQUFDLEVBRHZCLENBQ3VCLENBQUM7UUFDdEMsQ0FBQztRQUVELFNBQVMsUUFBUSxDQUFDLElBQVksRUFBRSxPQUFlLEVBQUUsUUFBYztZQUFkLHlCQUFBLEVBQUEsY0FBYztZQUM3RCxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN6QyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNyQixHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNsQix1RUFBdUU7WUFDdkUsc0JBQXNCO1lBQ3RCLDBEQUEwRDtZQUMxRCw2QkFBNkI7WUFDN0IsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDM0IsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksT0FBVCxJQUFJLFlBQU0sR0FBRyxHQUFLLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFDLENBQUM7Z0JBQ3RFLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDMUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7YUFDekQ7UUFDSCxDQUFDO1FBRUQ7Ozs7OztXQU1HO1FBQ0gsU0FBUyxnQkFBZ0IsQ0FBQyxXQUFtQixFQUFFLGFBQXNDO1lBQ25GLElBQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMxQyxJQUFNLFdBQVcsR0FBRyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDaEIsc0VBQXNFO2dCQUN0RSxtRUFBbUU7Z0JBQ25FLG9EQUFvRDtnQkFDcEQsMEVBQTBFO2dCQUMxRSxrRUFBa0U7Z0JBQ2xFLHlEQUF5RDtnQkFDekQsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDdEUsT0FBTyxDQUFDLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO2dCQUN0RSxPQUFPLENBQUMsS0FBSyxDQUNULGtGQUFrRixDQUFDLENBQUM7Z0JBQ3hGLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1lBRUQsd0VBQXdFO1lBQ3hFLGtGQUFrRjtZQUNsRiw2REFBNkQ7WUFDN0QsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDOUQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDN0QsYUFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFFbkUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDL0UsYUFBYSxDQUFDLFNBQVMsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDckYsYUFBYSxDQUFDLFNBQVMsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFFL0UsbUZBQW1GO1lBQ25GLDhEQUE4RDtZQUM5RCxxRkFBcUY7WUFDckYsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNqRCxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXBELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2hELENBQUM7UUFFRCxnRkFBZ0Y7UUFDaEYsbUVBQW1FO1FBQ25FLFNBQVMsYUFBYSxDQUFDLFdBQW1CLEVBQUUsR0FBVztZQUNyRCxJQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JDLDJEQUEyRDtZQUMzRCxJQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDeEUsSUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUM7WUFDN0UsSUFBSSxRQUFnQixDQUFDO1lBQ3JCLElBQUksR0FBRyxLQUFLLFNBQVMsRUFBRTtnQkFDckIsUUFBUSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDO2FBQ3pDO2lCQUFNLElBQUksU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ2pDLFFBQVEsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDekI7aUJBQU07Z0JBQ0wsUUFBUSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3pDO1lBQ0QsT0FBTyxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUUsUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsbUVBQW1FO1FBQ25FLFNBQVMsMEJBQTBCLENBQy9CLGNBQXNCLEVBQUUsWUFBb0IsRUFBRSxXQUFtQjtZQUNuRSxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBSyxjQUFjLG1CQUFnQixDQUFDLENBQUM7WUFDdkUsc0JBQXNCLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQy9DLFlBQVksRUFBRSxRQUFRO2dCQUN0QixTQUFTLEVBQUUsQ0FBQztnQkFDWixVQUFVLEVBQUUsRUFBRTtnQkFDZCxTQUFTLEVBQ0wsQ0FBQyxFQUFDLE1BQU0sRUFBRSxLQUFHLGNBQWMsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLENBQUMsQ0FBRyxFQUFDLENBQUM7Z0JBQzNGLHlCQUF5QixFQUFFLElBQUk7Z0JBQy9CLFVBQVUsRUFBRSxXQUFXO2FBQ3hCLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUNiLENBQUM7UUFFRDs7O1dBR0c7UUFDSCxTQUFTLHlCQUF5QixDQUFDLGNBQXNCLEVBQUUsT0FBZSxFQUFFLFdBQW1CO1lBQzdGLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFLLGNBQWMsVUFBTyxDQUFDLENBQUM7WUFDOUQsSUFBTSxPQUFPLEdBQU0sT0FBTywyQkFDWCxjQUFjLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFdBQ2hGLENBQUM7WUFDQSxzQkFBc0IsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUVEOzs7OztXQUtHO1FBQ0gsU0FBUywyQkFBMkIsQ0FBQyxHQUFXLEVBQUUscUJBQTZCO1lBQzdFLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUN2RCxJQUFNLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsRUFBQyxJQUFJLEVBQUUscUJBQXFCLEVBQUMsQ0FBQyxDQUFDO1lBQ3pFLHNCQUFzQixDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMzQyxDQUFDO0lBQ0gsQ0FBQztJQUVELElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7UUFDM0IsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNoRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHNoeCBmcm9tICdzaGVsbGpzJztcblxuZnVuY3Rpb24gbWFpbihhcmdzOiBzdHJpbmdbXSk6IG51bWJlciB7XG4gIC8vIEV4aXQgaW1tZWRpYXRlbHkgd2hlbiBlbmNvdW50ZXJpbmcgYW4gZXJyb3IuXG4gIHNoeC5zZXQoJy1lJyk7XG5cbiAgLy8gS2VlcCB0cmFjayBvZiB3aGV0aGVyIGFuIGVycm9yIGhhcyBvY2N1cmVkIHNvIHRoYXQgd2UgY2FuIHJldHVybiBhbiBhcHByb3ByaWF0ZSBleGl0IGNvZGUuXG4gIGxldCBlcnJvckhhc09jY3VyZWQgPSBmYWxzZTtcblxuICAvLyBUaGlzIHV0aWxpdHkgZXhwZWN0cyBhbGwgb2YgaXRzIGFyZ3VtZW50cyB0byBiZSBzcGVjaWZpZWQgaW4gYSBwYXJhbXMgZmlsZSBnZW5lcmF0ZWQgYnlcbiAgLy8gYmF6ZWwgKHNlZSBodHRwczovL2RvY3MuYmF6ZWwuYnVpbGQvdmVyc2lvbnMvbWFzdGVyL3NreWxhcmsvbGliL0FyZ3MuaHRtbCN1c2VfcGFyYW1fZmlsZSkuXG4gIGNvbnN0IHBhcmFtRmlsZVBhdGggPSBhcmdzWzBdO1xuXG4gIC8vIEJhemVsIHBhcmFtcyBtYXkgYmUgc3Vycm91bmRlZCB3aXRoIHF1b3Rlc1xuICBmdW5jdGlvbiB1bnF1b3RlUGFyYW1ldGVyKHM6IHN0cmluZykgeyByZXR1cm4gcy5yZXBsYWNlKC9eJyguKiknJC8sICckMScpOyB9XG5cbiAgLy8gUGFyYW1ldGVycyBhcmUgc3BlY2lmaWVkIGluIHRoZSBmaWxlIG9uZSBwZXIgbGluZS5cbiAgY29uc3QgcGFyYW1zID0gZnMucmVhZEZpbGVTeW5jKHBhcmFtRmlsZVBhdGgsICd1dGYtOCcpLnNwbGl0KCdcXG4nKS5tYXAodW5xdW90ZVBhcmFtZXRlcik7XG5cbiAgY29uc3QgW1xuICAgICAgLy8gT3V0cHV0IGRpcmVjdG9yeSBmb3IgdGhlIG5wbSBwYWNrYWdlLlxuICAgICAgb3V0LFxuXG4gICAgICAvLyBUaGUgcGFja2FnZSBzZWdtZW50IG9mIHRoZSBuZ19wYWNrYWdlIHJ1bGUncyBsYWJlbCAoZS5nLiAncGFja2FnZS9jb21tb24nKS5cbiAgICAgIHNyY0RpcixcblxuICAgICAgLy8gVGhlIGJhemVsLWJpbiBkaXIgam9pbmVkIHdpdGggdGhlIHNyY0RpciAoZS5nLiAnYmF6ZWwtYmluL3BhY2thZ2UuY29tbW9uJykuXG4gICAgICAvLyBUaGlzIGlzIHRoZSBpbnRlbmRlZCBvdXRwdXQgbG9jYXRpb24gZm9yIHBhY2thZ2UgYXJ0aWZhY3RzLlxuICAgICAgYmluRGlyLFxuXG4gICAgICAvLyBUaGUgYmF6ZWwtZ2VuZmlsZXMgZGlyIGpvaW5lZCB3aXRoIHRoZSBzcmNEaXIgKGUuZy4gJ2JhemVsLWJpbi9wYWNrYWdlLmNvbW1vbicpLlxuICAgICAgZ2VuZmlsZXNEaXIsXG5cbiAgICAgIC8vIEpTT04gZGF0YSBtYXBwaW5nIGVhY2ggZW50cnkgcG9pbnQgdG8gdGhlIGdlbmVyYXRlZCBidW5kbGUgaW5kZXggYW5kXG4gICAgICAvLyBmbGF0IG1vZHVsZSBtZXRhZGF0YSwgZm9yIGV4YW1wbGVcbiAgICAgIC8vIHtcIkBhbmd1bGFyL2NvcmVcIjoge1xuICAgICAgLy8gICAgIFwiaW5kZXhcIjogXCJiYXplbC1iaW4vcGFja2FnZXMvY29yZS9jb3JlLmpzXCIsXG4gICAgICAvLyAgICAgXCJ0eXBpbmdcIjogXCJiYXplbC1iaW4vcGFja2FnZXMvY29yZS9jb3JlLmQudHNcIixcbiAgICAgIC8vICAgICBcIm1ldGFkYXRhXCI6IFwiYmF6ZWwtYmluL3BhY2thZ2VzL2NvcmUvY29yZS5tZXRhZGF0YS5qc29uXCJcbiAgICAgIC8vICB9LFxuICAgICAgLy8gLi4uXG4gICAgICAvLyB9XG4gICAgICBtb2R1bGVzTWFuaWZlc3RBcmcsXG5cbiAgICAgIC8vIFBhdGggdG8gdGhlIHBhY2thZ2UncyBSRUFETUUubWQuXG4gICAgICByZWFkbWVNZCxcblxuICAgICAgLy8gTGlzdCBvZiByb2xsZWQtdXAgZmxhdCBFUzIwMTUgbW9kdWxlc1xuICAgICAgZmVzbTIwMTVBcmcsXG5cbiAgICAgIC8vIExpc3Qgb2Ygcm9sbGVkLXVwIGZsYXQgRVM1IG1vZHVsZXNcbiAgICAgIGZlc201QXJnLFxuXG4gICAgICAvLyBMaXN0IG9mIGluZGl2aWR1YWwgRVMyMDE1IG1vZHVsZXNcbiAgICAgIGVzbTIwMTVBcmcsXG5cbiAgICAgIC8vIExpc3Qgb2YgaW5kaXZpZHVhbCBFUzUgbW9kdWxlc1xuICAgICAgZXNtNUFyZyxcblxuICAgICAgLy8gTGlzdCBvZiBhbGwgVU1EIGJ1bmRsZXMgZ2VuZXJhdGVkIGJ5IHJvbGx1cC5cbiAgICAgIGJ1bmRsZXNBcmcsXG5cbiAgICAgIC8vIExpc3Qgb2YgYWxsIGZpbGVzIGluIHRoZSBuZ19wYWNrYWdlIHJ1bGUncyBzcmNzLlxuICAgICAgc3Jjc0FyZyxcblxuICAgICAgLy8gTGlzdCBvZiBhbGwgZmlsZXMgaW4gdGhlIG5nX3BhY2thZ2UgcnVsZSdzIGRhdGEuXG4gICAgICBkYXRhQXJnLFxuXG4gICAgICAvLyBQYXRoIHRvIHRoZSBwYWNrYWdlJ3MgTElDRU5TRS5cbiAgICAgIGxpY2Vuc2VGaWxlLFxuICBdID0gcGFyYW1zO1xuXG4gIGNvbnN0IGZlc20yMDE1ID0gZmVzbTIwMTVBcmcuc3BsaXQoJywnKS5maWx0ZXIocyA9PiAhIXMpO1xuICBjb25zdCBmZXNtNSA9IGZlc201QXJnLnNwbGl0KCcsJykuZmlsdGVyKHMgPT4gISFzKTtcbiAgY29uc3QgZXNtMjAxNSA9IGVzbTIwMTVBcmcuc3BsaXQoJywnKS5maWx0ZXIocyA9PiAhIXMpO1xuICBjb25zdCBlc201ID0gZXNtNUFyZy5zcGxpdCgnLCcpLmZpbHRlcihzID0+ICEhcyk7XG4gIGNvbnN0IGJ1bmRsZXMgPSBidW5kbGVzQXJnLnNwbGl0KCcsJykuZmlsdGVyKHMgPT4gISFzKTtcbiAgY29uc3Qgc3JjcyA9IHNyY3NBcmcuc3BsaXQoJywnKS5maWx0ZXIocyA9PiAhIXMpO1xuICBjb25zdCBkYXRhRmlsZXM6IHN0cmluZ1tdID0gZGF0YUFyZy5zcGxpdCgnLCcpLmZpbHRlcihzID0+ICEhcyk7XG4gIGNvbnN0IG1vZHVsZXNNYW5pZmVzdCA9IEpTT04ucGFyc2UobW9kdWxlc01hbmlmZXN0QXJnKTtcblxuICBpZiAocmVhZG1lTWQpIHtcbiAgICBjb3B5RmlsZShyZWFkbWVNZCwgb3V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXcml0ZXMgYSBmaWxlIGludG8gdGhlIHBhY2thZ2UgYmFzZWQgb24gaXRzIGlucHV0IHBhdGgsIHJlbGF0aXZpemluZyB0byB0aGUgcGFja2FnZSBwYXRoLlxuICAgKiBAcGFyYW0gaW5wdXRQYXRoIFBhdGggdG8gdGhlIGZpbGUgaW4gdGhlIGlucHV0IHRyZWUuXG4gICAqIEBwYXJhbSBmaWxlQ29udGVudCBDb250ZW50IG9mIHRoZSBmaWxlLlxuICAgKi9cbiAgZnVuY3Rpb24gd3JpdGVGaWxlRnJvbUlucHV0UGF0aChpbnB1dFBhdGg6IHN0cmluZywgZmlsZUNvbnRlbnQ6IHN0cmluZykge1xuICAgIC8vIFdlIHdhbnQgdGhlIHJlbGF0aXZlIHBhdGggZnJvbSB0aGUgZ2l2ZW4gZmlsZSB0byBpdHMgYW5jZXN0b3IgXCJyb290XCIgZGlyZWN0b3J5LlxuICAgIC8vIFRoaXMgcm9vdCBkZXBlbmRzIG9uIHdoZXRoZXIgdGhlIGZpbGUgbGl2ZXMgaW4gdGhlIHNvdXJjZSB0cmVlIChzcmNEaXIpIGFzIGEgYmFzaWMgZmlsZVxuICAgIC8vIGlucHV0IHRvIG5nX3BhY2thZ2UsIHRoZSBiaW4gb3V0cHV0IHRyZWUgKGJpbkRpcikgYXMgdGhlIG91dHB1dCBvZiBhbm90aGVyIHJ1bGUsIG9yXG4gICAgLy8gdGhlIGdlbmZpbGVzIG91dHB1dCB0cmVlIChnZW5maWxlc0RpcikgYXMgdGhlIG91dHB1dCBvZiBhIGdlbnJ1bGUuXG4gICAgbGV0IHJvb3REaXI6IHN0cmluZztcbiAgICBpZiAoaW5wdXRQYXRoLmluY2x1ZGVzKGJpbkRpcikpIHtcbiAgICAgIHJvb3REaXIgPSBiaW5EaXI7XG4gICAgfSBlbHNlIGlmIChpbnB1dFBhdGguaW5jbHVkZXMoZ2VuZmlsZXNEaXIpKSB7XG4gICAgICByb290RGlyID0gZ2VuZmlsZXNEaXI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJvb3REaXIgPSBzcmNEaXI7XG4gICAgfVxuXG4gICAgY29uc3Qgb3V0cHV0UGF0aCA9IHBhdGguam9pbihvdXQsIHBhdGgucmVsYXRpdmUocm9vdERpciwgaW5wdXRQYXRoKSk7XG5cbiAgICAvLyBBbHdheXMgZW5zdXJlIHRoYXQgdGhlIHRhcmdldCBkaXJlY3RvcnkgZXhpc3RzLlxuICAgIHNoeC5ta2RpcignLXAnLCBwYXRoLmRpcm5hbWUob3V0cHV0UGF0aCkpO1xuICAgIGZzLndyaXRlRmlsZVN5bmMob3V0cHV0UGF0aCwgZmlsZUNvbnRlbnQsICd1dGYtOCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvcGllcyBhIGZpbGUgaW50byB0aGUgcGFja2FnZSBiYXNlZCBvbiBpdHMgaW5wdXQgcGF0aCwgcmVsYXRpdml6aW5nIHRvIHRoZSBwYWNrYWdlIHBhdGguXG4gICAqIEBwYXJhbSBpbnB1dFBhdGggYSBwYXRoIHJlbGF0aXZlIHRvIHRoZSBiaW5EaXIsIHR5cGljYWxseSBmcm9tIGEgZmlsZSBpbiB0aGUgZGVwc1tdXG4gICAqL1xuICBmdW5jdGlvbiBjb3B5RmlsZUZyb21JbnB1dFBhdGgoaW5wdXRQYXRoOiBzdHJpbmcpIHtcbiAgICB3cml0ZUZpbGVGcm9tSW5wdXRQYXRoKGlucHV0UGF0aCwgZnMucmVhZEZpbGVTeW5jKGlucHV0UGF0aCwgJ3V0Zi04JykpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbGF0aXZpemUgdGhlIHBhdGggd2hlcmUgYSBmaWxlIGlzIHdyaXR0ZW4uXG4gICAqIEBwYXJhbSBmaWxlIGEgcGF0aCBjb250YWluaW5nIGEgcmUtcm9vdGVkIHNlZ21lbnQgbGlrZSAuZXNtNSBvciAuZXM2XG4gICAqIEBwYXJhbSBzdWZmaXggdGhlIHJlLXJvb3RlZCBkaXJlY3RvcnlcbiAgICogQHBhcmFtIG91dERpciBwYXRoIHdoZXJlIHdlIGNvcHkgdGhlIGZpbGUsIHJlbGF0aXZlIHRvIHRoZSBvdXRcbiAgICovXG4gIGZ1bmN0aW9uIHdyaXRlRXNtRmlsZShmaWxlOiBzdHJpbmcsIHN1ZmZpeDogc3RyaW5nLCBvdXREaXI6IHN0cmluZykge1xuICAgIGNvbnN0IHJvb3QgPSBmaWxlLnN1YnN0cigwLCBmaWxlLmxhc3RJbmRleE9mKHN1ZmZpeCArIHBhdGguc2VwKSArIHN1ZmZpeC5sZW5ndGggKyAxKTtcbiAgICBjb25zdCByZWwgPSBwYXRoLmRpcm5hbWUocGF0aC5yZWxhdGl2ZShwYXRoLmpvaW4ocm9vdCwgc3JjRGlyKSwgZmlsZSkpO1xuICAgIGlmICghcmVsLnN0YXJ0c1dpdGgoJy4uJykpIHtcbiAgICAgIGNvcHlGaWxlKGZpbGUsIHBhdGguam9pbihvdXQsIG91dERpciksIHJlbCk7XG4gICAgfVxuICB9XG5cbiAgZXNtMjAxNS5mb3JFYWNoKGZpbGUgPT4gd3JpdGVFc21GaWxlKGZpbGUsICcuZXM2JywgJ2VzbTIwMTUnKSk7XG4gIGVzbTUuZm9yRWFjaChmaWxlID0+IHdyaXRlRXNtRmlsZShmaWxlLCAnLmVzbTUnLCAnZXNtNScpKTtcblxuICBidW5kbGVzLmZvckVhY2goYnVuZGxlID0+IHsgY29weUZpbGUoYnVuZGxlLCBvdXQsICdidW5kbGVzJyk7IH0pO1xuICBmZXNtMjAxNS5mb3JFYWNoKGZpbGUgPT4geyBjb3B5RmlsZShmaWxlLCBvdXQsICdmZXNtMjAxNScpOyB9KTtcbiAgZmVzbTUuZm9yRWFjaChmaWxlID0+IHsgY29weUZpbGUoZmlsZSwgb3V0LCAnZmVzbTUnKTsgfSk7XG5cbiAgY29uc3QgYWxsc3JjcyA9IHNoeC5maW5kKCctUicsIGJpbkRpcik7XG4gIGFsbHNyY3MuZmlsdGVyKGhhc0ZpbGVFeHRlbnNpb24oJy5kLnRzJykpLmZvckVhY2goKGY6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoZiwgJ3V0Zi04JylcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0cmlwIHRoZSBuYW1lZCBBTUQgbW9kdWxlIGZvciBjb21wYXRpYmlsaXR5IHdpdGggbm9uLWJhemVsIHVzZXJzXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXlxcL1xcL1xcLyA8YW1kLW1vZHVsZSBuYW1lPS4qXFwvPlxcbi9nbSwgJycpO1xuICAgIHdyaXRlRmlsZUZyb21JbnB1dFBhdGgoZiwgY29udGVudCk7XG4gIH0pO1xuXG4gIC8vIENvcHkgYWxsIGBkYXRhYCBmaWxlcyBpbnRvIHRoZSBwYWNrYWdlLiBUaGVzZSBhcmUgZmlsZXMgdGhhdCBhcmVuJ3QgYnVpbHQgYnkgdGhlIG5nX3BhY2thZ2VcbiAgLy8gcnVsZSwgYnV0IGluc3RlYWQgYXJlIGp1c3Qgc3RyYWlnaHQgY29waWVkIGludG8gdGhlIHBhY2thZ2UsIGUuZy4gZ2xvYmFsIENTUyBhc3NldHMuXG4gIGRhdGFGaWxlcy5mb3JFYWNoKGYgPT4gY29weUZpbGVGcm9tSW5wdXRQYXRoKGYpKTtcblxuICAvLyBJdGVyYXRlIHRocm91Z2ggdGhlIGVudHJ5IHBvaW50IG1vZHVsZXNcbiAgLy8gV2UgZG8gdGhpcyBmaXJzdCBiZWNhdXNlIHdlIGFsc28gcmVjb3JkIG5ldyBwYXRocyBmb3IgdGhlIGVzbTUgYW5kIGVzbTIwMTUgY29waWVzXG4gIC8vIG9mIHRoZSBpbmRleCBKUyBmaWxlLCB3aGljaCB3ZSBuZWVkIHRvIGFtZW5kIHRoZSBwYWNrYWdlLmpzb24uXG4gIE9iamVjdC5rZXlzKG1vZHVsZXNNYW5pZmVzdCkuZm9yRWFjaChtb2R1bGVOYW1lID0+IHtcbiAgICBjb25zdCBtb2R1bGVGaWxlcyA9IG1vZHVsZXNNYW5pZmVzdFttb2R1bGVOYW1lXTtcbiAgICBjb25zdCByZWxhdGl2ZSA9IHBhdGgucmVsYXRpdmUoYmluRGlyLCBtb2R1bGVGaWxlc1snaW5kZXgnXSk7XG5cbiAgICBtb2R1bGVGaWxlc1snZXNtNV9pbmRleCddID0gcGF0aC5qb2luKGJpbkRpciwgJ2VzbTUnLCByZWxhdGl2ZSk7XG4gICAgbW9kdWxlRmlsZXNbJ2VzbTIwMTVfaW5kZXgnXSA9IHBhdGguam9pbihiaW5EaXIsICdlc20yMDE1JywgcmVsYXRpdmUpO1xuXG4gICAgY29weUZpbGVGcm9tSW5wdXRQYXRoKG1vZHVsZUZpbGVzWydtZXRhZGF0YSddKTtcbiAgfSk7XG5cbiAgLy8gUm9vdCBwYWNrYWdlIG5hbWUgKGUuZy4gJ0Bhbmd1bGFyL2NvbW1vbicpLCBjYXB0dXJlcyBhcyB3ZSBpdGVyYXRlIHRocm91Z2ggc291cmNlcyBiZWxvdy5cbiAgbGV0IHJvb3RQYWNrYWdlTmFtZSA9ICcnO1xuICBjb25zdCBwYWNrYWdlc1dpdGhFeGlzdGluZ1BhY2thZ2VKc29uID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgZm9yIChjb25zdCBzcmMgb2Ygc3Jjcykge1xuICAgIGlmIChzcmMuaW5jbHVkZXMoYmluRGlyKSB8fCBzcmMuaW5jbHVkZXMoZ2VuZmlsZXNEaXIpKSB7XG4gICAgICBlcnJvckhhc09jY3VyZWQgPSB0cnVlO1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICAnVGhlIFwic3Jjc1wiIGZvciBuZ19wYWNrYWdlIHNob3VsZCBub3QgaW5jbHVkZSBvdXRwdXQgb2Ygb3RoZXIgcnVsZXMuIEZvdW5kOlxcbicgK1xuICAgICAgICAgIGAgICR7c3JjfWApO1xuICAgIH1cblxuICAgIGxldCBjb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKHNyYywgJ3V0Zi04Jyk7XG4gICAgLy8gTW9kaWZ5IHBhY2thZ2UuanNvbiBmaWxlcyBhcyBuZWNlc3NhcnkgZm9yIHB1Ymxpc2hpbmdcbiAgICBpZiAocGF0aC5iYXNlbmFtZShzcmMpID09PSAncGFja2FnZS5qc29uJykge1xuICAgICAgY29uc3QgcGFja2FnZUpzb24gPSBKU09OLnBhcnNlKGNvbnRlbnQpO1xuICAgICAgY29udGVudCA9IGFtZW5kUGFja2FnZUpzb24oc3JjLCBwYWNrYWdlSnNvbik7XG5cbiAgICAgIGNvbnN0IHBhY2thZ2VOYW1lID0gcGFja2FnZUpzb25bJ25hbWUnXTtcbiAgICAgIHBhY2thZ2VzV2l0aEV4aXN0aW5nUGFja2FnZUpzb24uYWRkKHBhY2thZ2VOYW1lKTtcblxuICAgICAgLy8gS2VlcCB0cmFjayBvZiB0aGUgcm9vdCBwYWNrYWdlIG5hbWUsIGUuZy4gXCJAYW5ndWxhci9jb21tb25cIi4gV2UgYXNzdW1lIHRoYXQgdGhlXG4gICAgICAvLyByb290IG5hbWUgd2lsbCBiZSBzaG9ydGVzdCBiZWNhdXNlIHNlY29uZGFyeSBlbnRyeS1wb2ludHMgd2lsbCBhcHBlbmQgdG8gaXRcbiAgICAgIC8vIChlLmcuIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIikuXG4gICAgICBpZiAoIXJvb3RQYWNrYWdlTmFtZSB8fCBwYWNrYWdlTmFtZS5sZW5ndGggPCByb290UGFja2FnZU5hbWUubGVuZ3RoKSB7XG4gICAgICAgIHJvb3RQYWNrYWdlTmFtZSA9IHBhY2thZ2VKc29uWyduYW1lJ107XG4gICAgICB9XG4gICAgfVxuICAgIHdyaXRlRmlsZUZyb21JbnB1dFBhdGgoc3JjLCBjb250ZW50KTtcbiAgfVxuXG4gIGNvbnN0IGxpY2Vuc2VCYW5uZXIgPSBsaWNlbnNlRmlsZSA/IGZzLnJlYWRGaWxlU3luYyhsaWNlbnNlRmlsZSwgJ3V0Zi04JykgOiAnJztcblxuICAvLyBHZW5lcmF0ZSBleHRyYSBmaWxlcyBmb3Igc2Vjb25kYXJ5IGVudHJ5LXBvaW50cy5cbiAgT2JqZWN0LmtleXMobW9kdWxlc01hbmlmZXN0KS5mb3JFYWNoKGVudHJ5UG9pbnRQYWNrYWdlTmFtZSA9PiB7XG4gICAgY29uc3QgZW50cnlQb2ludE5hbWUgPSBlbnRyeVBvaW50UGFja2FnZU5hbWUuc3Vic3RyKHJvb3RQYWNrYWdlTmFtZS5sZW5ndGggKyAxKTtcbiAgICBpZiAoIWVudHJ5UG9pbnROYW1lKSByZXR1cm47XG5cbiAgICBjcmVhdGVNZXRhZGF0YVJlZXhwb3J0RmlsZShcbiAgICAgICAgZW50cnlQb2ludE5hbWUsIG1vZHVsZXNNYW5pZmVzdFtlbnRyeVBvaW50UGFja2FnZU5hbWVdWydtZXRhZGF0YSddLCBlbnRyeVBvaW50UGFja2FnZU5hbWUpO1xuICAgIGNyZWF0ZVR5cGluZ3NSZWV4cG9ydEZpbGUoXG4gICAgICAgIGVudHJ5UG9pbnROYW1lLCBsaWNlbnNlQmFubmVyLCBtb2R1bGVzTWFuaWZlc3RbZW50cnlQb2ludFBhY2thZ2VOYW1lXVsndHlwaW5ncyddKTtcblxuICAgIGlmICghcGFja2FnZXNXaXRoRXhpc3RpbmdQYWNrYWdlSnNvbi5oYXMoZW50cnlQb2ludFBhY2thZ2VOYW1lKSkge1xuICAgICAgY3JlYXRlRW50cnlQb2ludFBhY2thZ2VKc29uKGVudHJ5UG9pbnROYW1lLCBlbnRyeVBvaW50UGFja2FnZU5hbWUpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGVycm9ySGFzT2NjdXJlZCA/IDEgOiAwO1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgYmluRGlyLXJlbGF0aXZlIHBhdGggdG8gc3JjRGlyLXJlbGF0aXZlXG4gICAqIEBwYXJhbSBmcm9tIHBhdGggdG8gYSBmaWxlIHVuZGVyIHRoZSBzcmNEaXIsIGxpa2UgcGFja2FnZXMvY29yZS90ZXN0aW5nL3BhY2thZ2UuanNvblxuICAgKiBAcGFyYW0gZmlsZSBwYXRoIHRvIGEgZmlsZSB1bmRlciB0aGUgYmluRGlyLCBsaWtlIGJhemVsLWJpbi9jb3JlL3Rlc3RpbmcvZ2VuZXJhdGVkLmpzXG4gICAqL1xuICBmdW5jdGlvbiBzcmNEaXJSZWxhdGl2ZShmcm9tOiBzdHJpbmcsIGZpbGU6IHN0cmluZykge1xuICAgIGNvbnN0IHJlc3VsdCA9XG4gICAgICAgIHBhdGgucmVsYXRpdmUocGF0aC5kaXJuYW1lKGZyb20pLCBwYXRoLmpvaW4oc3JjRGlyLCBwYXRoLnJlbGF0aXZlKGJpbkRpciwgZmlsZSkpKTtcbiAgICBpZiAocmVzdWx0LnN0YXJ0c1dpdGgoJy4uJykpIHJldHVybiByZXN1bHQ7XG4gICAgcmV0dXJuIGAuLyR7cmVzdWx0fWA7XG4gIH1cblxuICAvKiogR2V0cyBhIHByZWRpY2F0ZSBmdW5jdGlvbiB0byBmaWx0ZXIgbm9uLWdlbmVyYXRlZCBmaWxlcyB3aXRoIGEgc3BlY2lmaWVkIGV4dGVuc2lvbi4gKi9cbiAgZnVuY3Rpb24gaGFzRmlsZUV4dGVuc2lvbihleHQ6IHN0cmluZyk6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW4ge1xuICAgIHJldHVybiBmID0+IGYuZW5kc1dpdGgoZXh0KSAmJiAhZi5lbmRzV2l0aChgLm5nZmFjdG9yeSR7ZXh0fWApICYmXG4gICAgICAgICFmLmVuZHNXaXRoKGAubmdzdW1tYXJ5JHtleHR9YCk7XG4gIH1cblxuICBmdW5jdGlvbiBjb3B5RmlsZShmaWxlOiBzdHJpbmcsIGJhc2VEaXI6IHN0cmluZywgcmVsYXRpdmUgPSAnLicpIHtcbiAgICBjb25zdCBkaXIgPSBwYXRoLmpvaW4oYmFzZURpciwgcmVsYXRpdmUpO1xuICAgIHNoeC5ta2RpcignLXAnLCBkaXIpO1xuICAgIHNoeC5jcChmaWxlLCBkaXIpO1xuICAgIC8vIERvdWJsZS11bmRlcnNjb3JlIGlzIHVzZWQgdG8gZXNjYXBlIGZvcndhcmQgc2xhc2ggaW4gRkVTTSBmaWxlbmFtZXMuXG4gICAgLy8gU2VlIG5nX3BhY2thZ2UuYnpsOlxuICAgIC8vICAgZmVzbV9vdXRwdXRfZmlsZW5hbWUgPSBlbnRyeV9wb2ludC5yZXBsYWNlKFwiL1wiLCBcIl9fXCIpXG4gICAgLy8gV2UgbmVlZCB0byB1bmVzY2FwZSB0aGVzZS5cbiAgICBpZiAoZmlsZS5pbmRleE9mKCdfXycpID49IDApIHtcbiAgICAgIGNvbnN0IG91dHB1dFBhdGggPSBwYXRoLmpvaW4oZGlyLCAuLi5wYXRoLmJhc2VuYW1lKGZpbGUpLnNwbGl0KCdfXycpKTtcbiAgICAgIHNoeC5ta2RpcignLXAnLCBwYXRoLmRpcm5hbWUob3V0cHV0UGF0aCkpO1xuICAgICAgc2h4Lm12KHBhdGguam9pbihkaXIsIHBhdGguYmFzZW5hbWUoZmlsZSkpLCBvdXRwdXRQYXRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW5zZXJ0cyBvciBlZGl0cyBwcm9wZXJ0aWVzIGludG8gdGhlIHBhY2thZ2UuanNvbiBmaWxlKHMpIGluIHRoZSBwYWNrYWdlIHNvIHRoYXRcbiAgICogdGhleSBwb2ludCB0byBhbGwgdGhlIHJpZ2h0IGdlbmVyYXRlZCBhcnRpZmFjdHMuXG4gICAqXG4gICAqIEBwYXJhbSBwYWNrYWdlSnNvbiBUaGUgcGF0aCB0byB0aGUgcGFja2FnZS5qc29uIGZpbGUuXG4gICAqIEBwYXJhbSBwYXJzZWRQYWNrYWdlIFBhcnNlZCBwYWNrYWdlLmpzb24gY29udGVudFxuICAgKi9cbiAgZnVuY3Rpb24gYW1lbmRQYWNrYWdlSnNvbihwYWNrYWdlSnNvbjogc3RyaW5nLCBwYXJzZWRQYWNrYWdlOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfSkge1xuICAgIGNvbnN0IHBhY2thZ2VOYW1lID0gcGFyc2VkUGFja2FnZVsnbmFtZSddO1xuICAgIGNvbnN0IG1vZHVsZUZpbGVzID0gbW9kdWxlc01hbmlmZXN0W3BhY2thZ2VOYW1lXTtcbiAgICBpZiAoIW1vZHVsZUZpbGVzKSB7XG4gICAgICAvLyBJZGVhbGx5IHdlIHNob3VsZCB0aHJvdyBoZXJlLCBhcyB3ZSBnb3QgYW4gZW50cnkgcG9pbnQgdGhhdCBkb2Vzbid0XG4gICAgICAvLyBoYXZlIGZsYXQgbW9kdWxlIG1ldGFkYXRhIC8gYnVuZGxlIGluZGV4LCBzbyBpdCBtYXkgaGF2ZSBiZWVuIGFuXG4gICAgICAvLyBuZ19tb2R1bGUgdGhhdCdzIG1pc3NpbmcgYSBtb2R1bGVfbmFtZSBhdHRyaWJ1dGUuXG4gICAgICAvLyBIb3dldmVyLCBAYW5ndWxhci9jb21waWxlciBjYW4ndCBiZSBhbiBuZ19tb2R1bGUsIGFzIGl0J3MgdGhlIGludGVybmFsc1xuICAgICAgLy8gb2YgdGhlIG5nYyBjb21waWxlciwgeWV0IHdlIHdhbnQgdG8gYnVpbGQgYW4gbmdfcGFja2FnZSBmb3IgaXQuXG4gICAgICAvLyBTbyBpZ25vcmUgcGFja2FnZS5qc29uIGZpbGVzIHdoZW4gd2UgYXJlIG1pc3NpbmcgZGF0YS5cbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1dBUk5JTkc6IG5vIG1vZHVsZSBtZXRhZGF0YSBmb3IgcGFja2FnZScsIHBhY2thZ2VOYW1lKTtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJyAgIE5vdCB1cGRhdGluZyB0aGUgcGFja2FnZS5qc29uIGZpbGUgdG8gcG9pbnQgdG8gaXQnKTtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgJyAgIFRoZSBuZ19tb2R1bGUgZm9yIHRoaXMgcGFja2FnZSBpcyBwb3NzaWJseSBtaXNzaW5nIHRoZSBtb2R1bGVfbmFtZSBhdHRyaWJ1dGUgJyk7XG4gICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocGFyc2VkUGFja2FnZSwgbnVsbCwgMik7XG4gICAgfVxuXG4gICAgLy8gRGVyaXZlIHRoZSBwYXRocyB0byB0aGUgZmlsZXMgZnJvbSB0aGUgaGFyZC1jb2RlZCBuYW1lcyB3ZSBnYXZlIHRoZW0uXG4gICAgLy8gVE9ETyhhbGV4ZWFnbGUpOiBpdCB3b3VsZCBiZSBiZXR0ZXIgdG8gdHJhbnNmZXIgdGhpcyBpbmZvcm1hdGlvbiBmcm9tIHRoZSBwbGFjZVxuICAgIC8vIHdoZXJlIHdlIGNyZWF0ZWQgdGhlIGZpbGVuYW1lcywgdmlhIHRoZSBtb2R1bGVzTWFuaWZlc3RBcmdcbiAgICBwYXJzZWRQYWNrYWdlWydtYWluJ10gPSBnZXRCdW5kbGVOYW1lKHBhY2thZ2VOYW1lLCAnYnVuZGxlcycpO1xuICAgIHBhcnNlZFBhY2thZ2VbJ2Zlc201J10gPSBnZXRCdW5kbGVOYW1lKHBhY2thZ2VOYW1lLCAnZmVzbTUnKTtcbiAgICBwYXJzZWRQYWNrYWdlWydmZXNtMjAxNSddID0gZ2V0QnVuZGxlTmFtZShwYWNrYWdlTmFtZSwgJ2Zlc20yMDE1Jyk7XG5cbiAgICBwYXJzZWRQYWNrYWdlWydlc201J10gPSBzcmNEaXJSZWxhdGl2ZShwYWNrYWdlSnNvbiwgbW9kdWxlRmlsZXNbJ2VzbTVfaW5kZXgnXSk7XG4gICAgcGFyc2VkUGFja2FnZVsnZXNtMjAxNSddID0gc3JjRGlyUmVsYXRpdmUocGFja2FnZUpzb24sIG1vZHVsZUZpbGVzWydlc20yMDE1X2luZGV4J10pO1xuICAgIHBhcnNlZFBhY2thZ2VbJ3R5cGluZ3MnXSA9IHNyY0RpclJlbGF0aXZlKHBhY2thZ2VKc29uLCBtb2R1bGVGaWxlc1sndHlwaW5ncyddKTtcblxuICAgIC8vIEZvciBub3csIHdlIHBvaW50IHRoZSBwcmltYXJ5IGVudHJ5IHBvaW50cyBhdCB0aGUgZmVzbSBmaWxlcywgYmVjYXVzZSBvZiBXZWJwYWNrXG4gICAgLy8gcGVyZm9ybWFuY2UgaXNzdWVzIHdpdGggYSBsYXJnZSBudW1iZXIgb2YgaW5kaXZpZHVhbCBmaWxlcy5cbiAgICAvLyBUT0RPKGltaW5hcik6IHJlc29sdmUgcGVyZm9ybWFuY2UgaXNzdWVzIHdpdGggdGhlIHRvb2xjaGFpbiBhbmQgcG9pbnQgdGhlc2UgdG8gZXNtXG4gICAgcGFyc2VkUGFja2FnZVsnbW9kdWxlJ10gPSBwYXJzZWRQYWNrYWdlWydmZXNtNSddO1xuICAgIHBhcnNlZFBhY2thZ2VbJ2VzMjAxNSddID0gcGFyc2VkUGFja2FnZVsnZmVzbTIwMTUnXTtcblxuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXJzZWRQYWNrYWdlLCBudWxsLCAyKTtcbiAgfVxuXG4gIC8vIGUuZy4gQGFuZ3VsYXIvY29tbW9uL2h0dHAvdGVzdGluZyAtPiAuLi8uLi9idW5kbGVzL2NvbW1vbi1odHRwLXRlc3RpbmcudW1kLmpzXG4gIC8vIG9yICAgQGFuZ3VsYXIvY29tbW9uL2h0dHAvdGVzdGluZyAtPiAuLi8uLi9mZXNtNS9odHRwL3Rlc3RpbmcuanNcbiAgZnVuY3Rpb24gZ2V0QnVuZGxlTmFtZShwYWNrYWdlTmFtZTogc3RyaW5nLCBkaXI6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcnRzID0gcGFja2FnZU5hbWUuc3BsaXQoJy8nKTtcbiAgICAvLyBSZW1vdmUgdGhlIHNjb3BlZCBwYWNrYWdlIHBhcnQsIGxpa2UgQGFuZ3VsYXIgaWYgcHJlc2VudFxuICAgIGNvbnN0IG5hbWVQYXJ0cyA9IHBhY2thZ2VOYW1lLnN0YXJ0c1dpdGgoJ0AnKSA/IHBhcnRzLnNwbGljZSgxKSA6IHBhcnRzO1xuICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IEFycmF5KG5hbWVQYXJ0cy5sZW5ndGggLSAxKS5maWxsKCcuLicpLmpvaW4oJy8nKSB8fCAnLic7XG4gICAgbGV0IGJhc2VuYW1lOiBzdHJpbmc7XG4gICAgaWYgKGRpciA9PT0gJ2J1bmRsZXMnKSB7XG4gICAgICBiYXNlbmFtZSA9IG5hbWVQYXJ0cy5qb2luKCctJykgKyAnLnVtZCc7XG4gICAgfSBlbHNlIGlmIChuYW1lUGFydHMubGVuZ3RoID09PSAxKSB7XG4gICAgICBiYXNlbmFtZSA9IG5hbWVQYXJ0c1swXTtcbiAgICB9IGVsc2Uge1xuICAgICAgYmFzZW5hbWUgPSBuYW1lUGFydHMuc2xpY2UoMSkuam9pbignLycpO1xuICAgIH1cbiAgICByZXR1cm4gW3JlbGF0aXZlUGF0aCwgZGlyLCBiYXNlbmFtZSArICcuanMnXS5qb2luKCcvJyk7XG4gIH1cblxuICAvKiogQ3JlYXRlcyBtZXRhZGF0YSByZS1leHBvcnQgZmlsZSBmb3IgYSBzZWNvbmRhcnkgZW50cnktcG9pbnQuICovXG4gIGZ1bmN0aW9uIGNyZWF0ZU1ldGFkYXRhUmVleHBvcnRGaWxlKFxuICAgICAgZW50cnlQb2ludE5hbWU6IHN0cmluZywgbWV0YWRhdGFGaWxlOiBzdHJpbmcsIHBhY2thZ2VOYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpbnB1dFBhdGggPSBwYXRoLmpvaW4oc3JjRGlyLCBgJHtlbnRyeVBvaW50TmFtZX0ubWV0YWRhdGEuanNvbmApO1xuICAgIHdyaXRlRmlsZUZyb21JbnB1dFBhdGgoaW5wdXRQYXRoLCBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAnX19zeW1ib2xpYyc6ICdtb2R1bGUnLFxuICAgICAgJ3ZlcnNpb24nOiAzLFxuICAgICAgJ21ldGFkYXRhJzoge30sXG4gICAgICAnZXhwb3J0cyc6XG4gICAgICAgICAgW3snZnJvbSc6IGAke3NyY0RpclJlbGF0aXZlKGlucHV0UGF0aCwgbWV0YWRhdGFGaWxlLnJlcGxhY2UoLy5tZXRhZGF0YS5qc29uJC8sICcnKSl9YH1dLFxuICAgICAgJ2ZsYXRNb2R1bGVJbmRleFJlZGlyZWN0JzogdHJ1ZSxcbiAgICAgICdpbXBvcnRBcyc6IHBhY2thZ2VOYW1lXG4gICAgfSkgKyAnXFxuJyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIHR5cGluZ3MgKGQudHMpIHJlLWV4cG9ydCBmaWxlIGZvciBhIHNlY29uZGFyeS1lbnRyeSBwb2ludCxcbiAgICogZS5nLiwgYGV4cG9ydCAqIGZyb20gJy4vY29tbW9uL2NvbW1vbidgXG4gICAqL1xuICBmdW5jdGlvbiBjcmVhdGVUeXBpbmdzUmVleHBvcnRGaWxlKGVudHJ5UG9pbnROYW1lOiBzdHJpbmcsIGxpY2Vuc2U6IHN0cmluZywgdHlwaW5nc0ZpbGU6IHN0cmluZykge1xuICAgIGNvbnN0IGlucHV0UGF0aCA9IHBhdGguam9pbihzcmNEaXIsIGAke2VudHJ5UG9pbnROYW1lfS5kLnRzYCk7XG4gICAgY29uc3QgY29udGVudCA9IGAke2xpY2Vuc2V9XG4gIGV4cG9ydCAqIGZyb20gJyR7c3JjRGlyUmVsYXRpdmUoaW5wdXRQYXRoLCB0eXBpbmdzRmlsZS5yZXBsYWNlKC9cXC5kXFwudHN4PyQvLCAnJykpfSc7XG4gIGA7XG4gICAgd3JpdGVGaWxlRnJvbUlucHV0UGF0aChpbnB1dFBhdGgsIGNvbnRlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBwYWNrYWdlLmpzb24gZm9yIGEgc2Vjb25kYXJ5IGVudHJ5LXBvaW50LlxuICAgKiBAcGFyYW0gZGlyIFRoZSBkaXJlY3RvcnkgdW5kZXIgd2hpY2ggdGhlIHBhY2thZ2UuanNvbiBzaG91bGQgYmUgd3JpdHRlbi5cbiAgICogQHBhcmFtIGVudHJ5UG9pbnRQYWNrYWdlTmFtZSBUaGUgZnVsbCBwYWNrYWdlIG5hbWUgZm9yIHRoZSBlbnRyeSBwb2ludCxcbiAgICogICAgIGUuZy4gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJy5cbiAgICovXG4gIGZ1bmN0aW9uIGNyZWF0ZUVudHJ5UG9pbnRQYWNrYWdlSnNvbihkaXI6IHN0cmluZywgZW50cnlQb2ludFBhY2thZ2VOYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwa2dKc29uID0gcGF0aC5qb2luKHNyY0RpciwgZGlyLCAncGFja2FnZS5qc29uJyk7XG4gICAgY29uc3QgY29udGVudCA9IGFtZW5kUGFja2FnZUpzb24ocGtnSnNvbiwge25hbWU6IGVudHJ5UG9pbnRQYWNrYWdlTmFtZX0pO1xuICAgIHdyaXRlRmlsZUZyb21JbnB1dFBhdGgocGtnSnNvbiwgY29udGVudCk7XG4gIH1cbn1cblxuaWYgKHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7XG4gIHByb2Nlc3MuZXhpdENvZGUgPSBtYWluKHByb2Nlc3MuYXJndi5zbGljZSgyKSk7XG59XG4iXX0=