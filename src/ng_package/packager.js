/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __values = (this && this.__values) || function (o) {
    var m = typeof Symbol === "function" && o[Symbol.iterator], i = 0;
    if (m) return m.call(o);
    return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("angular/packages/bazel/src/ng_package/packager", ["require", "exports", "fs", "path", "shelljs"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var fs = require("fs");
    var path = require("path");
    var shx = require("shelljs");
    function main(args) {
        var e_1, _a;
        // Exit immediately when encountering an error.
        shx.set('-e');
        // Keep track of whether an error has occured so that we can return an appropriate exit code.
        var errorHasOccured = false;
        // This utility expects all of its arguments to be specified in a params file generated by
        // bazel (see https://docs.bazel.build/versions/master/skylark/lib/Args.html#use_param_file).
        var paramFilePath = args[0];
        // Bazel params may be surrounded with quotes
        function unquoteParameter(s) { return s.replace(/^'(.*)'$/, '$1'); }
        // Parameters are specified in the file one per line.
        var params = fs.readFileSync(paramFilePath, 'utf-8').split('\n').map(unquoteParameter);
        var _b = __read(params, 15), 
        // Output directory for the npm package.
        out = _b[0], 
        // The package segment of the ng_package rule's label (e.g. 'package/common').
        srcDir = _b[1], 
        // The bazel-bin dir joined with the srcDir (e.g. 'bazel-bin/package.common').
        // This is the intended output location for package artifacts.
        binDir = _b[2], 
        // The bazel-genfiles dir joined with the srcDir (e.g. 'bazel-bin/package.common').
        genfilesDir = _b[3], 
        // JSON data mapping each entry point to the generated bundle index and
        // flat module metadata, for example
        // {"@angular/core": {
        //     "index": "bazel-bin/packages/core/core.js",
        //     "typing": "bazel-bin/packages/core/core.d.ts",
        //     "metadata": "bazel-bin/packages/core/core.metadata.json"
        //  },
        // ...
        // }
        modulesManifestArg = _b[4], 
        // Path to the package's README.md.
        readmeMd = _b[5], 
        // List of rolled-up flat ES2015 modules
        fesm2015Arg = _b[6], 
        // List of rolled-up flat ES5 modules
        fesm5Arg = _b[7], 
        // List of individual ES2015 modules
        esm2015Arg = _b[8], 
        // List of individual ES5 modules
        esm5Arg = _b[9], 
        // List of all UMD bundles generated by rollup.
        bundlesArg = _b[10], 
        // List of all files in the ng_package rule's srcs.
        srcsArg = _b[11], 
        // List of all type definitions that need to packaged into the ng_package.
        typeDefinitionsArg = _b[12], 
        // List of all files in the ng_package rule's data.
        dataArg = _b[13], 
        // Path to the package's LICENSE.
        licenseFile = _b[14];
        var fesm2015 = fesm2015Arg.split(',').filter(function (s) { return !!s; });
        var fesm5 = fesm5Arg.split(',').filter(function (s) { return !!s; });
        var esm2015 = esm2015Arg.split(',').filter(function (s) { return !!s; });
        var esm5 = esm5Arg.split(',').filter(function (s) { return !!s; });
        var bundles = bundlesArg.split(',').filter(function (s) { return !!s; });
        var typeDefinitions = typeDefinitionsArg.split(',').filter(function (s) { return !!s; });
        var srcs = srcsArg.split(',').filter(function (s) { return !!s; });
        var dataFiles = dataArg.split(',').filter(function (s) { return !!s; });
        var modulesManifest = JSON.parse(modulesManifestArg);
        if (readmeMd) {
            copyFile(readmeMd, out);
        }
        /**
         * Writes a file into the package based on its input path, relativizing to the package path.
         * @param inputPath Path to the file in the input tree.
         * @param fileContent Content of the file.
         */
        function writeFileFromInputPath(inputPath, fileContent) {
            // We want the relative path from the given file to its ancestor "root" directory.
            // This root depends on whether the file lives in the source tree (srcDir) as a basic file
            // input to ng_package, the bin output tree (binDir) as the output of another rule, or
            // the genfiles output tree (genfilesDir) as the output of a genrule.
            var rootDir;
            if (inputPath.includes(binDir)) {
                rootDir = binDir;
            }
            else if (inputPath.includes(genfilesDir)) {
                rootDir = genfilesDir;
            }
            else {
                rootDir = srcDir;
            }
            var outputPath = path.join(out, path.relative(rootDir, inputPath));
            // Always ensure that the target directory exists.
            shx.mkdir('-p', path.dirname(outputPath));
            fs.writeFileSync(outputPath, fileContent, 'utf-8');
        }
        /**
         * Copies a file into the package based on its input path, relativizing to the package path.
         * @param inputPath a path relative to the binDir, typically from a file in the deps[]
         */
        function copyFileFromInputPath(inputPath) {
            writeFileFromInputPath(inputPath, fs.readFileSync(inputPath, 'utf-8'));
        }
        /**
         * Relativize the path where a file is written.
         * @param file a path containing a re-rooted segment like .esm5 or .es6
         * @param suffix the re-rooted directory
         * @param outDir path where we copy the file, relative to the out
         */
        function writeEsmFile(file, suffix, outDir) {
            // Note that the specified file path is always using the posix path delimiter.
            var root = file.substr(0, file.lastIndexOf(suffix + "/") + suffix.length + 1);
            var rel = path.dirname(path.relative(path.join(root, srcDir), file));
            if (!rel.startsWith('..')) {
                copyFile(file, path.join(out, outDir), rel);
            }
        }
        esm2015.forEach(function (file) { return writeEsmFile(file, '.es6', 'esm2015'); });
        esm5.forEach(function (file) { return writeEsmFile(file, '.esm5', 'esm5'); });
        bundles.forEach(function (bundle) { copyFile(bundle, out, 'bundles'); });
        fesm2015.forEach(function (file) { copyFile(file, out, 'fesm2015'); });
        fesm5.forEach(function (file) { copyFile(file, out, 'fesm5'); });
        // Copy all type definitions into the package. This is necessary so that developers can use
        // the package with type definitions.
        typeDefinitions.forEach(function (f) {
            var content = fs.readFileSync(f, 'utf-8')
                // Strip the named AMD module for compatibility with non-bazel users
                .replace(/^\/\/\/ <amd-module name=.*\/>[\r\n]+/gm, '');
            writeFileFromInputPath(f, content);
        });
        // Copy all `data` files into the package. These are files that aren't built by the ng_package
        // rule, but instead are just straight copied into the package, e.g. global CSS assets.
        dataFiles.forEach(function (f) { return copyFileFromInputPath(f); });
        // Iterate through the entry point modules
        // We do this first because we also record new paths for the esm5 and esm2015 copies
        // of the index JS file, which we need to amend the package.json.
        Object.keys(modulesManifest).forEach(function (moduleName) {
            var moduleFiles = modulesManifest[moduleName];
            var relative = path.relative(binDir, moduleFiles['index']);
            moduleFiles['esm5_index'] = path.join(binDir, 'esm5', relative);
            moduleFiles['esm2015_index'] = path.join(binDir, 'esm2015', relative);
            copyFileFromInputPath(moduleFiles['metadata']);
        });
        // Root package name (e.g. '@angular/common'), captures as we iterate through sources below.
        var rootPackageName = '';
        var packagesWithExistingPackageJson = new Set();
        try {
            for (var srcs_1 = __values(srcs), srcs_1_1 = srcs_1.next(); !srcs_1_1.done; srcs_1_1 = srcs_1.next()) {
                var src = srcs_1_1.value;
                if (src.includes(binDir) || src.includes(genfilesDir)) {
                    errorHasOccured = true;
                    console.error('The "srcs" for ng_package should not include output of other rules. Found:\n' +
                        ("  " + src));
                }
                var content = fs.readFileSync(src, 'utf-8');
                // Modify package.json files as necessary for publishing
                if (path.basename(src) === 'package.json') {
                    var packageJson = JSON.parse(content);
                    content = amendPackageJson(src, packageJson);
                    var packageName = packageJson['name'];
                    packagesWithExistingPackageJson.add(packageName);
                    // Keep track of the root package name, e.g. "@angular/common". We assume that the
                    // root name will be shortest because secondary entry-points will append to it
                    // (e.g. "@angular/common/http").
                    if (!rootPackageName || packageName.length < rootPackageName.length) {
                        rootPackageName = packageJson['name'];
                    }
                }
                writeFileFromInputPath(src, content);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (srcs_1_1 && !srcs_1_1.done && (_a = srcs_1.return)) _a.call(srcs_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        var licenseBanner = licenseFile ? fs.readFileSync(licenseFile, 'utf-8') : '';
        // Generate extra files for secondary entry-points.
        Object.keys(modulesManifest).forEach(function (entryPointPackageName) {
            var entryPointName = entryPointPackageName.substr(rootPackageName.length + 1);
            if (!entryPointName)
                return;
            createMetadataReexportFile(entryPointName, modulesManifest[entryPointPackageName]['metadata'], entryPointPackageName);
            createTypingsReexportFile(entryPointName, licenseBanner, modulesManifest[entryPointPackageName]['typings']);
            if (!packagesWithExistingPackageJson.has(entryPointPackageName)) {
                createEntryPointPackageJson(entryPointName, entryPointPackageName);
            }
        });
        return errorHasOccured ? 1 : 0;
        /**
         * Convert a binDir-relative path to srcDir-relative
         * @param from path to a file under the srcDir, like packages/core/testing/package.json
         * @param file path to a file under the binDir, like bazel-bin/core/testing/generated.js
         */
        function srcDirRelative(from, file) {
            var result = normalizeSeparators(path.relative(path.dirname(from), path.join(srcDir, path.relative(binDir, file))));
            if (result.startsWith('..'))
                return result;
            return "./" + result;
        }
        function copyFile(file, baseDir, relative) {
            if (relative === void 0) { relative = '.'; }
            var dir = path.join(baseDir, relative);
            shx.mkdir('-p', dir);
            shx.cp(file, dir);
            // Double-underscore is used to escape forward slash in FESM filenames.
            // See ng_package.bzl:
            //   fesm_output_filename = entry_point.replace("/", "__")
            // We need to unescape these.
            if (file.indexOf('__') >= 0) {
                var outputPath = path.join.apply(path, __spread([dir], path.basename(file).split('__')));
                shx.mkdir('-p', path.dirname(outputPath));
                shx.mv(path.join(dir, path.basename(file)), outputPath);
                // if we are renaming the .js file, we'll also need to update the sourceMappingURL in the file
                if (file.endsWith('.js')) {
                    shx.chmod('+w', outputPath);
                    shx.sed('-i', path.basename(file) + ".map", path.basename(outputPath) + ".map", outputPath);
                }
            }
        }
        /**
         * Inserts or edits properties into the package.json file(s) in the package so that
         * they point to all the right generated artifacts.
         *
         * @param packageJson The path to the package.json file.
         * @param parsedPackage Parsed package.json content
         */
        function amendPackageJson(packageJson, parsedPackage) {
            var packageName = parsedPackage['name'];
            var moduleFiles = modulesManifest[packageName];
            if (!moduleFiles) {
                // Ideally we should throw here, as we got an entry point that doesn't
                // have flat module metadata / bundle index, so it may have been an
                // ng_module that's missing a module_name attribute.
                // However, @angular/compiler can't be an ng_module, as it's the internals
                // of the ngc compiler, yet we want to build an ng_package for it.
                // So ignore package.json files when we are missing data.
                console.error('WARNING: no module metadata for package', packageName);
                console.error('   Not updating the package.json file to point to it');
                console.error('   The ng_module for this package is possibly missing the module_name attribute ');
                return JSON.stringify(parsedPackage, null, 2);
            }
            // Derive the paths to the files from the hard-coded names we gave them.
            // TODO(alexeagle): it would be better to transfer this information from the place
            // where we created the filenames, via the modulesManifestArg
            parsedPackage['main'] = getBundleName(packageName, 'bundles');
            parsedPackage['fesm5'] = getBundleName(packageName, 'fesm5');
            parsedPackage['fesm2015'] = getBundleName(packageName, 'fesm2015');
            parsedPackage['esm5'] = srcDirRelative(packageJson, moduleFiles['esm5_index']);
            parsedPackage['esm2015'] = srcDirRelative(packageJson, moduleFiles['esm2015_index']);
            parsedPackage['typings'] = srcDirRelative(packageJson, moduleFiles['typings']);
            // For now, we point the primary entry points at the fesm files, because of Webpack
            // performance issues with a large number of individual files.
            // TODO(iminar): resolve performance issues with the toolchain and point these to esm
            parsedPackage['module'] = parsedPackage['fesm5'];
            parsedPackage['es2015'] = parsedPackage['fesm2015'];
            return JSON.stringify(parsedPackage, null, 2);
        }
        // e.g. @angular/common/http/testing -> ../../bundles/common-http-testing.umd.js
        // or   @angular/common/http/testing -> ../../fesm5/http/testing.js
        function getBundleName(packageName, dir) {
            var parts = packageName.split('/');
            // Remove the scoped package part, like @angular if present
            var nameParts = packageName.startsWith('@') ? parts.splice(1) : parts;
            var relativePath = Array(nameParts.length - 1).fill('..').join('/') || '.';
            var basename;
            if (dir === 'bundles') {
                basename = nameParts.join('-') + '.umd';
            }
            else if (nameParts.length === 1) {
                basename = nameParts[0];
            }
            else {
                basename = nameParts.slice(1).join('/');
            }
            return [relativePath, dir, basename + '.js'].join('/');
        }
        /** Creates metadata re-export file for a secondary entry-point. */
        function createMetadataReexportFile(entryPointName, metadataFile, packageName) {
            var inputPath = path.join(srcDir, entryPointName + ".metadata.json");
            writeFileFromInputPath(inputPath, JSON.stringify({
                '__symbolic': 'module',
                'version': 3,
                'metadata': {},
                'exports': [{ 'from': "" + srcDirRelative(inputPath, metadataFile.replace(/.metadata.json$/, '')) }],
                'flatModuleIndexRedirect': true,
                'importAs': packageName
            }) + '\n');
        }
        /**
         * Creates a typings (d.ts) re-export file for a secondary-entry point,
         * e.g., `export * from './common/common'`
         */
        function createTypingsReexportFile(entryPointName, license, typingsFile) {
            var inputPath = path.join(srcDir, entryPointName + ".d.ts");
            var content = license + "\nexport * from '" + srcDirRelative(inputPath, typingsFile.replace(/\.d\.tsx?$/, '')) + "';\n";
            writeFileFromInputPath(inputPath, content);
        }
        /**
         * Creates a package.json for a secondary entry-point.
         * @param dir The directory under which the package.json should be written.
         * @param entryPointPackageName The full package name for the entry point,
         *     e.g. '@angular/common/http'.
         */
        function createEntryPointPackageJson(dir, entryPointPackageName) {
            var pkgJson = path.join(srcDir, dir, 'package.json');
            var content = amendPackageJson(pkgJson, { name: entryPointPackageName });
            writeFileFromInputPath(pkgJson, content);
        }
        /**
         * Normalizes the specified path by replacing backslash separators with Posix
         * forward slash separators.
         */
        function normalizeSeparators(path) { return path.replace(/\\/g, '/'); }
    }
    if (require.main === module) {
        process.exitCode = main(process.argv.slice(2));
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC9zcmMvbmdfcGFja2FnZS9wYWNrYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUVILHVCQUF5QjtJQUN6QiwyQkFBNkI7SUFDN0IsNkJBQStCO0lBRS9CLFNBQVMsSUFBSSxDQUFDLElBQWM7O1FBQzFCLCtDQUErQztRQUMvQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWQsNkZBQTZGO1FBQzdGLElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQztRQUU1QiwwRkFBMEY7UUFDMUYsNkZBQTZGO1FBQzdGLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU5Qiw2Q0FBNkM7UUFDN0MsU0FBUyxnQkFBZ0IsQ0FBQyxDQUFTLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFNUUscURBQXFEO1FBQ3JELElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUVuRixJQUFBLHVCQXNESTtRQXJETix3Q0FBd0M7UUFDeEMsV0FBRztRQUVILDhFQUE4RTtRQUM5RSxjQUFNO1FBRU4sOEVBQThFO1FBQzlFLDhEQUE4RDtRQUM5RCxjQUFNO1FBRU4sbUZBQW1GO1FBQ25GLG1CQUFXO1FBRVgsdUVBQXVFO1FBQ3ZFLG9DQUFvQztRQUNwQyxzQkFBc0I7UUFDdEIsa0RBQWtEO1FBQ2xELHFEQUFxRDtRQUNyRCwrREFBK0Q7UUFDL0QsTUFBTTtRQUNOLE1BQU07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QUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2hEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc2h4IGZyb20gJ3NoZWxsanMnO1xuXG5mdW5jdGlvbiBtYWluKGFyZ3M6IHN0cmluZ1tdKTogbnVtYmVyIHtcbiAgLy8gRXhpdCBpbW1lZGlhdGVseSB3aGVuIGVuY291bnRlcmluZyBhbiBlcnJvci5cbiAgc2h4LnNldCgnLWUnKTtcblxuICAvLyBLZWVwIHRyYWNrIG9mIHdoZXRoZXIgYW4gZXJyb3IgaGFzIG9jY3VyZWQgc28gdGhhdCB3ZSBjYW4gcmV0dXJuIGFuIGFwcHJvcHJpYXRlIGV4aXQgY29kZS5cbiAgbGV0IGVycm9ySGFzT2NjdXJlZCA9IGZhbHNlO1xuXG4gIC8vIFRoaXMgdXRpbGl0eSBleHBlY3RzIGFsbCBvZiBpdHMgYXJndW1lbnRzIHRvIGJlIHNwZWNpZmllZCBpbiBhIHBhcmFtcyBmaWxlIGdlbmVyYXRlZCBieVxuICAvLyBiYXplbCAoc2VlIGh0dHBzOi8vZG9jcy5iYXplbC5idWlsZC92ZXJzaW9ucy9tYXN0ZXIvc2t5bGFyay9saWIvQXJncy5odG1sI3VzZV9wYXJhbV9maWxlKS5cbiAgY29uc3QgcGFyYW1GaWxlUGF0aCA9IGFyZ3NbMF07XG5cbiAgLy8gQmF6ZWwgcGFyYW1zIG1heSBiZSBzdXJyb3VuZGVkIHdpdGggcXVvdGVzXG4gIGZ1bmN0aW9uIHVucXVvdGVQYXJhbWV0ZXIoczogc3RyaW5nKSB7IHJldHVybiBzLnJlcGxhY2UoL14nKC4qKSckLywgJyQxJyk7IH1cblxuICAvLyBQYXJhbWV0ZXJzIGFyZSBzcGVjaWZpZWQgaW4gdGhlIGZpbGUgb25lIHBlciBsaW5lLlxuICBjb25zdCBwYXJhbXMgPSBmcy5yZWFkRmlsZVN5bmMocGFyYW1GaWxlUGF0aCwgJ3V0Zi04Jykuc3BsaXQoJ1xcbicpLm1hcCh1bnF1b3RlUGFyYW1ldGVyKTtcblxuICBjb25zdCBbXG4gICAgICAvLyBPdXRwdXQgZGlyZWN0b3J5IGZvciB0aGUgbnBtIHBhY2thZ2UuXG4gICAgICBvdXQsXG5cbiAgICAgIC8vIFRoZSBwYWNrYWdlIHNlZ21lbnQgb2YgdGhlIG5nX3BhY2thZ2UgcnVsZSdzIGxhYmVsIChlLmcuICdwYWNrYWdlL2NvbW1vbicpLlxuICAgICAgc3JjRGlyLFxuXG4gICAgICAvLyBUaGUgYmF6ZWwtYmluIGRpciBqb2luZWQgd2l0aCB0aGUgc3JjRGlyIChlLmcuICdiYXplbC1iaW4vcGFja2FnZS5jb21tb24nKS5cbiAgICAgIC8vIFRoaXMgaXMgdGhlIGludGVuZGVkIG91dHB1dCBsb2NhdGlvbiBmb3IgcGFja2FnZSBhcnRpZmFjdHMuXG4gICAgICBiaW5EaXIsXG5cbiAgICAgIC8vIFRoZSBiYXplbC1nZW5maWxlcyBkaXIgam9pbmVkIHdpdGggdGhlIHNyY0RpciAoZS5nLiAnYmF6ZWwtYmluL3BhY2thZ2UuY29tbW9uJykuXG4gICAgICBnZW5maWxlc0RpcixcblxuICAgICAgLy8gSlNPTiBkYXRhIG1hcHBpbmcgZWFjaCBlbnRyeSBwb2ludCB0byB0aGUgZ2VuZXJhdGVkIGJ1bmRsZSBpbmRleCBhbmRcbiAgICAgIC8vIGZsYXQgbW9kdWxlIG1ldGFkYXRhLCBmb3IgZXhhbXBsZVxuICAgICAgLy8ge1wiQGFuZ3VsYXIvY29yZVwiOiB7XG4gICAgICAvLyAgICAgXCJpbmRleFwiOiBcImJhemVsLWJpbi9wYWNrYWdlcy9jb3JlL2NvcmUuanNcIixcbiAgICAgIC8vICAgICBcInR5cGluZ1wiOiBcImJhemVsLWJpbi9wYWNrYWdlcy9jb3JlL2NvcmUuZC50c1wiLFxuICAgICAgLy8gICAgIFwibWV0YWRhdGFcIjogXCJiYXplbC1iaW4vcGFja2FnZXMvY29yZS9jb3JlLm1ldGFkYXRhLmpzb25cIlxuICAgICAgLy8gIH0sXG4gICAgICAvLyAuLi5cbiAgICAgIC8vIH1cbiAgICAgIG1vZHVsZXNNYW5pZmVzdEFyZyxcblxuICAgICAgLy8gUGF0aCB0byB0aGUgcGFja2FnZSdzIFJFQURNRS5tZC5cbiAgICAgIHJlYWRtZU1kLFxuXG4gICAgICAvLyBMaXN0IG9mIHJvbGxlZC11cCBmbGF0IEVTMjAxNSBtb2R1bGVzXG4gICAgICBmZXNtMjAxNUFyZyxcblxuICAgICAgLy8gTGlzdCBvZiByb2xsZWQtdXAgZmxhdCBFUzUgbW9kdWxlc1xuICAgICAgZmVzbTVBcmcsXG5cbiAgICAgIC8vIExpc3Qgb2YgaW5kaXZpZHVhbCBFUzIwMTUgbW9kdWxlc1xuICAgICAgZXNtMjAxNUFyZyxcblxuICAgICAgLy8gTGlzdCBvZiBpbmRpdmlkdWFsIEVTNSBtb2R1bGVzXG4gICAgICBlc201QXJnLFxuXG4gICAgICAvLyBMaXN0IG9mIGFsbCBVTUQgYnVuZGxlcyBnZW5lcmF0ZWQgYnkgcm9sbHVwLlxuICAgICAgYnVuZGxlc0FyZyxcblxuICAgICAgLy8gTGlzdCBvZiBhbGwgZmlsZXMgaW4gdGhlIG5nX3BhY2thZ2UgcnVsZSdzIHNyY3MuXG4gICAgICBzcmNzQXJnLFxuXG4gICAgICAvLyBMaXN0IG9mIGFsbCB0eXBlIGRlZmluaXRpb25zIHRoYXQgbmVlZCB0byBwYWNrYWdlZCBpbnRvIHRoZSBuZ19wYWNrYWdlLlxuICAgICAgdHlwZURlZmluaXRpb25zQXJnLFxuXG4gICAgICAvLyBMaXN0IG9mIGFsbCBmaWxlcyBpbiB0aGUgbmdfcGFja2FnZSBydWxlJ3MgZGF0YS5cbiAgICAgIGRhdGFBcmcsXG5cbiAgICAgIC8vIFBhdGggdG8gdGhlIHBhY2thZ2UncyBMSUNFTlNFLlxuICAgICAgbGljZW5zZUZpbGUsXG4gIF0gPSBwYXJhbXM7XG5cbiAgY29uc3QgZmVzbTIwMTUgPSBmZXNtMjAxNUFyZy5zcGxpdCgnLCcpLmZpbHRlcihzID0+ICEhcyk7XG4gIGNvbnN0IGZlc201ID0gZmVzbTVBcmcuc3BsaXQoJywnKS5maWx0ZXIocyA9PiAhIXMpO1xuICBjb25zdCBlc20yMDE1ID0gZXNtMjAxNUFyZy5zcGxpdCgnLCcpLmZpbHRlcihzID0+ICEhcyk7XG4gIGNvbnN0IGVzbTUgPSBlc201QXJnLnNwbGl0KCcsJykuZmlsdGVyKHMgPT4gISFzKTtcbiAgY29uc3QgYnVuZGxlcyA9IGJ1bmRsZXNBcmcuc3BsaXQoJywnKS5maWx0ZXIocyA9PiAhIXMpO1xuICBjb25zdCB0eXBlRGVmaW5pdGlvbnMgPSB0eXBlRGVmaW5pdGlvbnNBcmcuc3BsaXQoJywnKS5maWx0ZXIocyA9PiAhIXMpO1xuICBjb25zdCBzcmNzID0gc3Jjc0FyZy5zcGxpdCgnLCcpLmZpbHRlcihzID0+ICEhcyk7XG4gIGNvbnN0IGRhdGFGaWxlczogc3RyaW5nW10gPSBkYXRhQXJnLnNwbGl0KCcsJykuZmlsdGVyKHMgPT4gISFzKTtcbiAgY29uc3QgbW9kdWxlc01hbmlmZXN0ID0gSlNPTi5wYXJzZShtb2R1bGVzTWFuaWZlc3RBcmcpO1xuXG4gIGlmIChyZWFkbWVNZCkge1xuICAgIGNvcHlGaWxlKHJlYWRtZU1kLCBvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdyaXRlcyBhIGZpbGUgaW50byB0aGUgcGFja2FnZSBiYXNlZCBvbiBpdHMgaW5wdXQgcGF0aCwgcmVsYXRpdml6aW5nIHRvIHRoZSBwYWNrYWdlIHBhdGguXG4gICAqIEBwYXJhbSBpbnB1dFBhdGggUGF0aCB0byB0aGUgZmlsZSBpbiB0aGUgaW5wdXQgdHJlZS5cbiAgICogQHBhcmFtIGZpbGVDb250ZW50IENvbnRlbnQgb2YgdGhlIGZpbGUuXG4gICAqL1xuICBmdW5jdGlvbiB3cml0ZUZpbGVGcm9tSW5wdXRQYXRoKGlucHV0UGF0aDogc3RyaW5nLCBmaWxlQ29udGVudDogc3RyaW5nKSB7XG4gICAgLy8gV2Ugd2FudCB0aGUgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBnaXZlbiBmaWxlIHRvIGl0cyBhbmNlc3RvciBcInJvb3RcIiBkaXJlY3RvcnkuXG4gICAgLy8gVGhpcyByb290IGRlcGVuZHMgb24gd2hldGhlciB0aGUgZmlsZSBsaXZlcyBpbiB0aGUgc291cmNlIHRyZWUgKHNyY0RpcikgYXMgYSBiYXNpYyBmaWxlXG4gICAgLy8gaW5wdXQgdG8gbmdfcGFja2FnZSwgdGhlIGJpbiBvdXRwdXQgdHJlZSAoYmluRGlyKSBhcyB0aGUgb3V0cHV0IG9mIGFub3RoZXIgcnVsZSwgb3JcbiAgICAvLyB0aGUgZ2VuZmlsZXMgb3V0cHV0IHRyZWUgKGdlbmZpbGVzRGlyKSBhcyB0aGUgb3V0cHV0IG9mIGEgZ2VucnVsZS5cbiAgICBsZXQgcm9vdERpcjogc3RyaW5nO1xuICAgIGlmIChpbnB1dFBhdGguaW5jbHVkZXMoYmluRGlyKSkge1xuICAgICAgcm9vdERpciA9IGJpbkRpcjtcbiAgICB9IGVsc2UgaWYgKGlucHV0UGF0aC5pbmNsdWRlcyhnZW5maWxlc0RpcikpIHtcbiAgICAgIHJvb3REaXIgPSBnZW5maWxlc0RpcjtcbiAgICB9IGVsc2Uge1xuICAgICAgcm9vdERpciA9IHNyY0RpcjtcbiAgICB9XG5cbiAgICBjb25zdCBvdXRwdXRQYXRoID0gcGF0aC5qb2luKG91dCwgcGF0aC5yZWxhdGl2ZShyb290RGlyLCBpbnB1dFBhdGgpKTtcblxuICAgIC8vIEFsd2F5cyBlbnN1cmUgdGhhdCB0aGUgdGFyZ2V0IGRpcmVjdG9yeSBleGlzdHMuXG4gICAgc2h4Lm1rZGlyKCctcCcsIHBhdGguZGlybmFtZShvdXRwdXRQYXRoKSk7XG4gICAgZnMud3JpdGVGaWxlU3luYyhvdXRwdXRQYXRoLCBmaWxlQ29udGVudCwgJ3V0Zi04Jyk7XG4gIH1cblxuICAvKipcbiAgICogQ29waWVzIGEgZmlsZSBpbnRvIHRoZSBwYWNrYWdlIGJhc2VkIG9uIGl0cyBpbnB1dCBwYXRoLCByZWxhdGl2aXppbmcgdG8gdGhlIHBhY2thZ2UgcGF0aC5cbiAgICogQHBhcmFtIGlucHV0UGF0aCBhIHBhdGggcmVsYXRpdmUgdG8gdGhlIGJpbkRpciwgdHlwaWNhbGx5IGZyb20gYSBmaWxlIGluIHRoZSBkZXBzW11cbiAgICovXG4gIGZ1bmN0aW9uIGNvcHlGaWxlRnJvbUlucHV0UGF0aChpbnB1dFBhdGg6IHN0cmluZykge1xuICAgIHdyaXRlRmlsZUZyb21JbnB1dFBhdGgoaW5wdXRQYXRoLCBmcy5yZWFkRmlsZVN5bmMoaW5wdXRQYXRoLCAndXRmLTgnKSk7XG4gIH1cblxuICAvKipcbiAgICogUmVsYXRpdml6ZSB0aGUgcGF0aCB3aGVyZSBhIGZpbGUgaXMgd3JpdHRlbi5cbiAgICogQHBhcmFtIGZpbGUgYSBwYXRoIGNvbnRhaW5pbmcgYSByZS1yb290ZWQgc2VnbWVudCBsaWtlIC5lc201IG9yIC5lczZcbiAgICogQHBhcmFtIHN1ZmZpeCB0aGUgcmUtcm9vdGVkIGRpcmVjdG9yeVxuICAgKiBAcGFyYW0gb3V0RGlyIHBhdGggd2hlcmUgd2UgY29weSB0aGUgZmlsZSwgcmVsYXRpdmUgdG8gdGhlIG91dFxuICAgKi9cbiAgZnVuY3Rpb24gd3JpdGVFc21GaWxlKGZpbGU6IHN0cmluZywgc3VmZml4OiBzdHJpbmcsIG91dERpcjogc3RyaW5nKSB7XG4gICAgLy8gTm90ZSB0aGF0IHRoZSBzcGVjaWZpZWQgZmlsZSBwYXRoIGlzIGFsd2F5cyB1c2luZyB0aGUgcG9zaXggcGF0aCBkZWxpbWl0ZXIuXG4gICAgY29uc3Qgcm9vdCA9IGZpbGUuc3Vic3RyKDAsIGZpbGUubGFzdEluZGV4T2YoYCR7c3VmZml4fS9gKSArIHN1ZmZpeC5sZW5ndGggKyAxKTtcbiAgICBjb25zdCByZWwgPSBwYXRoLmRpcm5hbWUocGF0aC5yZWxhdGl2ZShwYXRoLmpvaW4ocm9vdCwgc3JjRGlyKSwgZmlsZSkpO1xuICAgIGlmICghcmVsLnN0YXJ0c1dpdGgoJy4uJykpIHtcbiAgICAgIGNvcHlGaWxlKGZpbGUsIHBhdGguam9pbihvdXQsIG91dERpciksIHJlbCk7XG4gICAgfVxuICB9XG5cbiAgZXNtMjAxNS5mb3JFYWNoKGZpbGUgPT4gd3JpdGVFc21GaWxlKGZpbGUsICcuZXM2JywgJ2VzbTIwMTUnKSk7XG4gIGVzbTUuZm9yRWFjaChmaWxlID0+IHdyaXRlRXNtRmlsZShmaWxlLCAnLmVzbTUnLCAnZXNtNScpKTtcblxuICBidW5kbGVzLmZvckVhY2goYnVuZGxlID0+IHsgY29weUZpbGUoYnVuZGxlLCBvdXQsICdidW5kbGVzJyk7IH0pO1xuICBmZXNtMjAxNS5mb3JFYWNoKGZpbGUgPT4geyBjb3B5RmlsZShmaWxlLCBvdXQsICdmZXNtMjAxNScpOyB9KTtcbiAgZmVzbTUuZm9yRWFjaChmaWxlID0+IHsgY29weUZpbGUoZmlsZSwgb3V0LCAnZmVzbTUnKTsgfSk7XG5cbiAgLy8gQ29weSBhbGwgdHlwZSBkZWZpbml0aW9ucyBpbnRvIHRoZSBwYWNrYWdlLiBUaGlzIGlzIG5lY2Vzc2FyeSBzbyB0aGF0IGRldmVsb3BlcnMgY2FuIHVzZVxuICAvLyB0aGUgcGFja2FnZSB3aXRoIHR5cGUgZGVmaW5pdGlvbnMuXG4gIHR5cGVEZWZpbml0aW9ucy5mb3JFYWNoKChmOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBjb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGYsICd1dGYtOCcpXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBTdHJpcCB0aGUgbmFtZWQgQU1EIG1vZHVsZSBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG5vbi1iYXplbCB1c2Vyc1xuICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL15cXC9cXC9cXC8gPGFtZC1tb2R1bGUgbmFtZT0uKlxcLz5bXFxyXFxuXSsvZ20sICcnKTtcbiAgICB3cml0ZUZpbGVGcm9tSW5wdXRQYXRoKGYsIGNvbnRlbnQpO1xuICB9KTtcblxuICAvLyBDb3B5IGFsbCBgZGF0YWAgZmlsZXMgaW50byB0aGUgcGFja2FnZS4gVGhlc2UgYXJlIGZpbGVzIHRoYXQgYXJlbid0IGJ1aWx0IGJ5IHRoZSBuZ19wYWNrYWdlXG4gIC8vIHJ1bGUsIGJ1dCBpbnN0ZWFkIGFyZSBqdXN0IHN0cmFpZ2h0IGNvcGllZCBpbnRvIHRoZSBwYWNrYWdlLCBlLmcuIGdsb2JhbCBDU1MgYXNzZXRzLlxuICBkYXRhRmlsZXMuZm9yRWFjaChmID0+IGNvcHlGaWxlRnJvbUlucHV0UGF0aChmKSk7XG5cbiAgLy8gSXRlcmF0ZSB0aHJvdWdoIHRoZSBlbnRyeSBwb2ludCBtb2R1bGVzXG4gIC8vIFdlIGRvIHRoaXMgZmlyc3QgYmVjYXVzZSB3ZSBhbHNvIHJlY29yZCBuZXcgcGF0aHMgZm9yIHRoZSBlc201IGFuZCBlc20yMDE1IGNvcGllc1xuICAvLyBvZiB0aGUgaW5kZXggSlMgZmlsZSwgd2hpY2ggd2UgbmVlZCB0byBhbWVuZCB0aGUgcGFja2FnZS5qc29uLlxuICBPYmplY3Qua2V5cyhtb2R1bGVzTWFuaWZlc3QpLmZvckVhY2gobW9kdWxlTmFtZSA9PiB7XG4gICAgY29uc3QgbW9kdWxlRmlsZXMgPSBtb2R1bGVzTWFuaWZlc3RbbW9kdWxlTmFtZV07XG4gICAgY29uc3QgcmVsYXRpdmUgPSBwYXRoLnJlbGF0aXZlKGJpbkRpciwgbW9kdWxlRmlsZXNbJ2luZGV4J10pO1xuXG4gICAgbW9kdWxlRmlsZXNbJ2VzbTVfaW5kZXgnXSA9IHBhdGguam9pbihiaW5EaXIsICdlc201JywgcmVsYXRpdmUpO1xuICAgIG1vZHVsZUZpbGVzWydlc20yMDE1X2luZGV4J10gPSBwYXRoLmpvaW4oYmluRGlyLCAnZXNtMjAxNScsIHJlbGF0aXZlKTtcblxuICAgIGNvcHlGaWxlRnJvbUlucHV0UGF0aChtb2R1bGVGaWxlc1snbWV0YWRhdGEnXSk7XG4gIH0pO1xuXG4gIC8vIFJvb3QgcGFja2FnZSBuYW1lIChlLmcuICdAYW5ndWxhci9jb21tb24nKSwgY2FwdHVyZXMgYXMgd2UgaXRlcmF0ZSB0aHJvdWdoIHNvdXJjZXMgYmVsb3cuXG4gIGxldCByb290UGFja2FnZU5hbWUgPSAnJztcbiAgY29uc3QgcGFja2FnZXNXaXRoRXhpc3RpbmdQYWNrYWdlSnNvbiA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gIGZvciAoY29uc3Qgc3JjIG9mIHNyY3MpIHtcbiAgICBpZiAoc3JjLmluY2x1ZGVzKGJpbkRpcikgfHwgc3JjLmluY2x1ZGVzKGdlbmZpbGVzRGlyKSkge1xuICAgICAgZXJyb3JIYXNPY2N1cmVkID0gdHJ1ZTtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgJ1RoZSBcInNyY3NcIiBmb3IgbmdfcGFja2FnZSBzaG91bGQgbm90IGluY2x1ZGUgb3V0cHV0IG9mIG90aGVyIHJ1bGVzLiBGb3VuZDpcXG4nICtcbiAgICAgICAgICBgICAke3NyY31gKTtcbiAgICB9XG5cbiAgICBsZXQgY29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhzcmMsICd1dGYtOCcpO1xuICAgIC8vIE1vZGlmeSBwYWNrYWdlLmpzb24gZmlsZXMgYXMgbmVjZXNzYXJ5IGZvciBwdWJsaXNoaW5nXG4gICAgaWYgKHBhdGguYmFzZW5hbWUoc3JjKSA9PT0gJ3BhY2thZ2UuanNvbicpIHtcbiAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gSlNPTi5wYXJzZShjb250ZW50KTtcbiAgICAgIGNvbnRlbnQgPSBhbWVuZFBhY2thZ2VKc29uKHNyYywgcGFja2FnZUpzb24pO1xuXG4gICAgICBjb25zdCBwYWNrYWdlTmFtZSA9IHBhY2thZ2VKc29uWyduYW1lJ107XG4gICAgICBwYWNrYWdlc1dpdGhFeGlzdGluZ1BhY2thZ2VKc29uLmFkZChwYWNrYWdlTmFtZSk7XG5cbiAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIHJvb3QgcGFja2FnZSBuYW1lLCBlLmcuIFwiQGFuZ3VsYXIvY29tbW9uXCIuIFdlIGFzc3VtZSB0aGF0IHRoZVxuICAgICAgLy8gcm9vdCBuYW1lIHdpbGwgYmUgc2hvcnRlc3QgYmVjYXVzZSBzZWNvbmRhcnkgZW50cnktcG9pbnRzIHdpbGwgYXBwZW5kIHRvIGl0XG4gICAgICAvLyAoZS5nLiBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCIpLlxuICAgICAgaWYgKCFyb290UGFja2FnZU5hbWUgfHwgcGFja2FnZU5hbWUubGVuZ3RoIDwgcm9vdFBhY2thZ2VOYW1lLmxlbmd0aCkge1xuICAgICAgICByb290UGFja2FnZU5hbWUgPSBwYWNrYWdlSnNvblsnbmFtZSddO1xuICAgICAgfVxuICAgIH1cbiAgICB3cml0ZUZpbGVGcm9tSW5wdXRQYXRoKHNyYywgY29udGVudCk7XG4gIH1cblxuICBjb25zdCBsaWNlbnNlQmFubmVyID0gbGljZW5zZUZpbGUgPyBmcy5yZWFkRmlsZVN5bmMobGljZW5zZUZpbGUsICd1dGYtOCcpIDogJyc7XG5cbiAgLy8gR2VuZXJhdGUgZXh0cmEgZmlsZXMgZm9yIHNlY29uZGFyeSBlbnRyeS1wb2ludHMuXG4gIE9iamVjdC5rZXlzKG1vZHVsZXNNYW5pZmVzdCkuZm9yRWFjaChlbnRyeVBvaW50UGFja2FnZU5hbWUgPT4ge1xuICAgIGNvbnN0IGVudHJ5UG9pbnROYW1lID0gZW50cnlQb2ludFBhY2thZ2VOYW1lLnN1YnN0cihyb290UGFja2FnZU5hbWUubGVuZ3RoICsgMSk7XG4gICAgaWYgKCFlbnRyeVBvaW50TmFtZSkgcmV0dXJuO1xuXG4gICAgY3JlYXRlTWV0YWRhdGFSZWV4cG9ydEZpbGUoXG4gICAgICAgIGVudHJ5UG9pbnROYW1lLCBtb2R1bGVzTWFuaWZlc3RbZW50cnlQb2ludFBhY2thZ2VOYW1lXVsnbWV0YWRhdGEnXSwgZW50cnlQb2ludFBhY2thZ2VOYW1lKTtcbiAgICBjcmVhdGVUeXBpbmdzUmVleHBvcnRGaWxlKFxuICAgICAgICBlbnRyeVBvaW50TmFtZSwgbGljZW5zZUJhbm5lciwgbW9kdWxlc01hbmlmZXN0W2VudHJ5UG9pbnRQYWNrYWdlTmFtZV1bJ3R5cGluZ3MnXSk7XG5cbiAgICBpZiAoIXBhY2thZ2VzV2l0aEV4aXN0aW5nUGFja2FnZUpzb24uaGFzKGVudHJ5UG9pbnRQYWNrYWdlTmFtZSkpIHtcbiAgICAgIGNyZWF0ZUVudHJ5UG9pbnRQYWNrYWdlSnNvbihlbnRyeVBvaW50TmFtZSwgZW50cnlQb2ludFBhY2thZ2VOYW1lKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBlcnJvckhhc09jY3VyZWQgPyAxIDogMDtcblxuICAvKipcbiAgICogQ29udmVydCBhIGJpbkRpci1yZWxhdGl2ZSBwYXRoIHRvIHNyY0Rpci1yZWxhdGl2ZVxuICAgKiBAcGFyYW0gZnJvbSBwYXRoIHRvIGEgZmlsZSB1bmRlciB0aGUgc3JjRGlyLCBsaWtlIHBhY2thZ2VzL2NvcmUvdGVzdGluZy9wYWNrYWdlLmpzb25cbiAgICogQHBhcmFtIGZpbGUgcGF0aCB0byBhIGZpbGUgdW5kZXIgdGhlIGJpbkRpciwgbGlrZSBiYXplbC1iaW4vY29yZS90ZXN0aW5nL2dlbmVyYXRlZC5qc1xuICAgKi9cbiAgZnVuY3Rpb24gc3JjRGlyUmVsYXRpdmUoZnJvbTogc3RyaW5nLCBmaWxlOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXN1bHQgPSBub3JtYWxpemVTZXBhcmF0b3JzKFxuICAgICAgICBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShmcm9tKSwgcGF0aC5qb2luKHNyY0RpciwgcGF0aC5yZWxhdGl2ZShiaW5EaXIsIGZpbGUpKSkpO1xuICAgIGlmIChyZXN1bHQuc3RhcnRzV2l0aCgnLi4nKSkgcmV0dXJuIHJlc3VsdDtcbiAgICByZXR1cm4gYC4vJHtyZXN1bHR9YDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNvcHlGaWxlKGZpbGU6IHN0cmluZywgYmFzZURpcjogc3RyaW5nLCByZWxhdGl2ZSA9ICcuJykge1xuICAgIGNvbnN0IGRpciA9IHBhdGguam9pbihiYXNlRGlyLCByZWxhdGl2ZSk7XG4gICAgc2h4Lm1rZGlyKCctcCcsIGRpcik7XG4gICAgc2h4LmNwKGZpbGUsIGRpcik7XG4gICAgLy8gRG91YmxlLXVuZGVyc2NvcmUgaXMgdXNlZCB0byBlc2NhcGUgZm9yd2FyZCBzbGFzaCBpbiBGRVNNIGZpbGVuYW1lcy5cbiAgICAvLyBTZWUgbmdfcGFja2FnZS5iemw6XG4gICAgLy8gICBmZXNtX291dHB1dF9maWxlbmFtZSA9IGVudHJ5X3BvaW50LnJlcGxhY2UoXCIvXCIsIFwiX19cIilcbiAgICAvLyBXZSBuZWVkIHRvIHVuZXNjYXBlIHRoZXNlLlxuICAgIGlmIChmaWxlLmluZGV4T2YoJ19fJykgPj0gMCkge1xuICAgICAgY29uc3Qgb3V0cHV0UGF0aCA9IHBhdGguam9pbihkaXIsIC4uLnBhdGguYmFzZW5hbWUoZmlsZSkuc3BsaXQoJ19fJykpO1xuICAgICAgc2h4Lm1rZGlyKCctcCcsIHBhdGguZGlybmFtZShvdXRwdXRQYXRoKSk7XG4gICAgICBzaHgubXYocGF0aC5qb2luKGRpciwgcGF0aC5iYXNlbmFtZShmaWxlKSksIG91dHB1dFBhdGgpO1xuXG4gICAgICAvLyBpZiB3ZSBhcmUgcmVuYW1pbmcgdGhlIC5qcyBmaWxlLCB3ZSdsbCBhbHNvIG5lZWQgdG8gdXBkYXRlIHRoZSBzb3VyY2VNYXBwaW5nVVJMIGluIHRoZSBmaWxlXG4gICAgICBpZiAoZmlsZS5lbmRzV2l0aCgnLmpzJykpIHtcbiAgICAgICAgc2h4LmNobW9kKCcrdycsIG91dHB1dFBhdGgpO1xuICAgICAgICBzaHguc2VkKCctaScsIGAke3BhdGguYmFzZW5hbWUoZmlsZSl9Lm1hcGAsIGAke3BhdGguYmFzZW5hbWUob3V0cHV0UGF0aCl9Lm1hcGAsIG91dHB1dFBhdGgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnNlcnRzIG9yIGVkaXRzIHByb3BlcnRpZXMgaW50byB0aGUgcGFja2FnZS5qc29uIGZpbGUocykgaW4gdGhlIHBhY2thZ2Ugc28gdGhhdFxuICAgKiB0aGV5IHBvaW50IHRvIGFsbCB0aGUgcmlnaHQgZ2VuZXJhdGVkIGFydGlmYWN0cy5cbiAgICpcbiAgICogQHBhcmFtIHBhY2thZ2VKc29uIFRoZSBwYXRoIHRvIHRoZSBwYWNrYWdlLmpzb24gZmlsZS5cbiAgICogQHBhcmFtIHBhcnNlZFBhY2thZ2UgUGFyc2VkIHBhY2thZ2UuanNvbiBjb250ZW50XG4gICAqL1xuICBmdW5jdGlvbiBhbWVuZFBhY2thZ2VKc29uKHBhY2thZ2VKc29uOiBzdHJpbmcsIHBhcnNlZFBhY2thZ2U6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9KSB7XG4gICAgY29uc3QgcGFja2FnZU5hbWUgPSBwYXJzZWRQYWNrYWdlWyduYW1lJ107XG4gICAgY29uc3QgbW9kdWxlRmlsZXMgPSBtb2R1bGVzTWFuaWZlc3RbcGFja2FnZU5hbWVdO1xuICAgIGlmICghbW9kdWxlRmlsZXMpIHtcbiAgICAgIC8vIElkZWFsbHkgd2Ugc2hvdWxkIHRocm93IGhlcmUsIGFzIHdlIGdvdCBhbiBlbnRyeSBwb2ludCB0aGF0IGRvZXNuJ3RcbiAgICAgIC8vIGhhdmUgZmxhdCBtb2R1bGUgbWV0YWRhdGEgLyBidW5kbGUgaW5kZXgsIHNvIGl0IG1heSBoYXZlIGJlZW4gYW5cbiAgICAgIC8vIG5nX21vZHVsZSB0aGF0J3MgbWlzc2luZyBhIG1vZHVsZV9uYW1lIGF0dHJpYnV0ZS5cbiAgICAgIC8vIEhvd2V2ZXIsIEBhbmd1bGFyL2NvbXBpbGVyIGNhbid0IGJlIGFuIG5nX21vZHVsZSwgYXMgaXQncyB0aGUgaW50ZXJuYWxzXG4gICAgICAvLyBvZiB0aGUgbmdjIGNvbXBpbGVyLCB5ZXQgd2Ugd2FudCB0byBidWlsZCBhbiBuZ19wYWNrYWdlIGZvciBpdC5cbiAgICAgIC8vIFNvIGlnbm9yZSBwYWNrYWdlLmpzb24gZmlsZXMgd2hlbiB3ZSBhcmUgbWlzc2luZyBkYXRhLlxuICAgICAgY29uc29sZS5lcnJvcignV0FSTklORzogbm8gbW9kdWxlIG1ldGFkYXRhIGZvciBwYWNrYWdlJywgcGFja2FnZU5hbWUpO1xuICAgICAgY29uc29sZS5lcnJvcignICAgTm90IHVwZGF0aW5nIHRoZSBwYWNrYWdlLmpzb24gZmlsZSB0byBwb2ludCB0byBpdCcpO1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICAnICAgVGhlIG5nX21vZHVsZSBmb3IgdGhpcyBwYWNrYWdlIGlzIHBvc3NpYmx5IG1pc3NpbmcgdGhlIG1vZHVsZV9uYW1lIGF0dHJpYnV0ZSAnKTtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShwYXJzZWRQYWNrYWdlLCBudWxsLCAyKTtcbiAgICB9XG5cbiAgICAvLyBEZXJpdmUgdGhlIHBhdGhzIHRvIHRoZSBmaWxlcyBmcm9tIHRoZSBoYXJkLWNvZGVkIG5hbWVzIHdlIGdhdmUgdGhlbS5cbiAgICAvLyBUT0RPKGFsZXhlYWdsZSk6IGl0IHdvdWxkIGJlIGJldHRlciB0byB0cmFuc2ZlciB0aGlzIGluZm9ybWF0aW9uIGZyb20gdGhlIHBsYWNlXG4gICAgLy8gd2hlcmUgd2UgY3JlYXRlZCB0aGUgZmlsZW5hbWVzLCB2aWEgdGhlIG1vZHVsZXNNYW5pZmVzdEFyZ1xuICAgIHBhcnNlZFBhY2thZ2VbJ21haW4nXSA9IGdldEJ1bmRsZU5hbWUocGFja2FnZU5hbWUsICdidW5kbGVzJyk7XG4gICAgcGFyc2VkUGFja2FnZVsnZmVzbTUnXSA9IGdldEJ1bmRsZU5hbWUocGFja2FnZU5hbWUsICdmZXNtNScpO1xuICAgIHBhcnNlZFBhY2thZ2VbJ2Zlc20yMDE1J10gPSBnZXRCdW5kbGVOYW1lKHBhY2thZ2VOYW1lLCAnZmVzbTIwMTUnKTtcblxuICAgIHBhcnNlZFBhY2thZ2VbJ2VzbTUnXSA9IHNyY0RpclJlbGF0aXZlKHBhY2thZ2VKc29uLCBtb2R1bGVGaWxlc1snZXNtNV9pbmRleCddKTtcbiAgICBwYXJzZWRQYWNrYWdlWydlc20yMDE1J10gPSBzcmNEaXJSZWxhdGl2ZShwYWNrYWdlSnNvbiwgbW9kdWxlRmlsZXNbJ2VzbTIwMTVfaW5kZXgnXSk7XG4gICAgcGFyc2VkUGFja2FnZVsndHlwaW5ncyddID0gc3JjRGlyUmVsYXRpdmUocGFja2FnZUpzb24sIG1vZHVsZUZpbGVzWyd0eXBpbmdzJ10pO1xuXG4gICAgLy8gRm9yIG5vdywgd2UgcG9pbnQgdGhlIHByaW1hcnkgZW50cnkgcG9pbnRzIGF0IHRoZSBmZXNtIGZpbGVzLCBiZWNhdXNlIG9mIFdlYnBhY2tcbiAgICAvLyBwZXJmb3JtYW5jZSBpc3N1ZXMgd2l0aCBhIGxhcmdlIG51bWJlciBvZiBpbmRpdmlkdWFsIGZpbGVzLlxuICAgIC8vIFRPRE8oaW1pbmFyKTogcmVzb2x2ZSBwZXJmb3JtYW5jZSBpc3N1ZXMgd2l0aCB0aGUgdG9vbGNoYWluIGFuZCBwb2ludCB0aGVzZSB0byBlc21cbiAgICBwYXJzZWRQYWNrYWdlWydtb2R1bGUnXSA9IHBhcnNlZFBhY2thZ2VbJ2Zlc201J107XG4gICAgcGFyc2VkUGFja2FnZVsnZXMyMDE1J10gPSBwYXJzZWRQYWNrYWdlWydmZXNtMjAxNSddO1xuXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHBhcnNlZFBhY2thZ2UsIG51bGwsIDIpO1xuICB9XG5cbiAgLy8gZS5nLiBAYW5ndWxhci9jb21tb24vaHR0cC90ZXN0aW5nIC0+IC4uLy4uL2J1bmRsZXMvY29tbW9uLWh0dHAtdGVzdGluZy51bWQuanNcbiAgLy8gb3IgICBAYW5ndWxhci9jb21tb24vaHR0cC90ZXN0aW5nIC0+IC4uLy4uL2Zlc201L2h0dHAvdGVzdGluZy5qc1xuICBmdW5jdGlvbiBnZXRCdW5kbGVOYW1lKHBhY2thZ2VOYW1lOiBzdHJpbmcsIGRpcjogc3RyaW5nKSB7XG4gICAgY29uc3QgcGFydHMgPSBwYWNrYWdlTmFtZS5zcGxpdCgnLycpO1xuICAgIC8vIFJlbW92ZSB0aGUgc2NvcGVkIHBhY2thZ2UgcGFydCwgbGlrZSBAYW5ndWxhciBpZiBwcmVzZW50XG4gICAgY29uc3QgbmFtZVBhcnRzID0gcGFja2FnZU5hbWUuc3RhcnRzV2l0aCgnQCcpID8gcGFydHMuc3BsaWNlKDEpIDogcGFydHM7XG4gICAgY29uc3QgcmVsYXRpdmVQYXRoID0gQXJyYXkobmFtZVBhcnRzLmxlbmd0aCAtIDEpLmZpbGwoJy4uJykuam9pbignLycpIHx8ICcuJztcbiAgICBsZXQgYmFzZW5hbWU6IHN0cmluZztcbiAgICBpZiAoZGlyID09PSAnYnVuZGxlcycpIHtcbiAgICAgIGJhc2VuYW1lID0gbmFtZVBhcnRzLmpvaW4oJy0nKSArICcudW1kJztcbiAgICB9IGVsc2UgaWYgKG5hbWVQYXJ0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIGJhc2VuYW1lID0gbmFtZVBhcnRzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBiYXNlbmFtZSA9IG5hbWVQYXJ0cy5zbGljZSgxKS5qb2luKCcvJyk7XG4gICAgfVxuICAgIHJldHVybiBbcmVsYXRpdmVQYXRoLCBkaXIsIGJhc2VuYW1lICsgJy5qcyddLmpvaW4oJy8nKTtcbiAgfVxuXG4gIC8qKiBDcmVhdGVzIG1ldGFkYXRhIHJlLWV4cG9ydCBmaWxlIGZvciBhIHNlY29uZGFyeSBlbnRyeS1wb2ludC4gKi9cbiAgZnVuY3Rpb24gY3JlYXRlTWV0YWRhdGFSZWV4cG9ydEZpbGUoXG4gICAgICBlbnRyeVBvaW50TmFtZTogc3RyaW5nLCBtZXRhZGF0YUZpbGU6IHN0cmluZywgcGFja2FnZU5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IGlucHV0UGF0aCA9IHBhdGguam9pbihzcmNEaXIsIGAke2VudHJ5UG9pbnROYW1lfS5tZXRhZGF0YS5qc29uYCk7XG4gICAgd3JpdGVGaWxlRnJvbUlucHV0UGF0aChpbnB1dFBhdGgsIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICdfX3N5bWJvbGljJzogJ21vZHVsZScsXG4gICAgICAndmVyc2lvbic6IDMsXG4gICAgICAnbWV0YWRhdGEnOiB7fSxcbiAgICAgICdleHBvcnRzJzpcbiAgICAgICAgICBbeydmcm9tJzogYCR7c3JjRGlyUmVsYXRpdmUoaW5wdXRQYXRoLCBtZXRhZGF0YUZpbGUucmVwbGFjZSgvLm1ldGFkYXRhLmpzb24kLywgJycpKX1gfV0sXG4gICAgICAnZmxhdE1vZHVsZUluZGV4UmVkaXJlY3QnOiB0cnVlLFxuICAgICAgJ2ltcG9ydEFzJzogcGFja2FnZU5hbWVcbiAgICB9KSArICdcXG4nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgdHlwaW5ncyAoZC50cykgcmUtZXhwb3J0IGZpbGUgZm9yIGEgc2Vjb25kYXJ5LWVudHJ5IHBvaW50LFxuICAgKiBlLmcuLCBgZXhwb3J0ICogZnJvbSAnLi9jb21tb24vY29tbW9uJ2BcbiAgICovXG4gIGZ1bmN0aW9uIGNyZWF0ZVR5cGluZ3NSZWV4cG9ydEZpbGUoZW50cnlQb2ludE5hbWU6IHN0cmluZywgbGljZW5zZTogc3RyaW5nLCB0eXBpbmdzRmlsZTogc3RyaW5nKSB7XG4gICAgY29uc3QgaW5wdXRQYXRoID0gcGF0aC5qb2luKHNyY0RpciwgYCR7ZW50cnlQb2ludE5hbWV9LmQudHNgKTtcbiAgICBjb25zdCBjb250ZW50ID0gYCR7bGljZW5zZX1cbmV4cG9ydCAqIGZyb20gJyR7c3JjRGlyUmVsYXRpdmUoaW5wdXRQYXRoLCB0eXBpbmdzRmlsZS5yZXBsYWNlKC9cXC5kXFwudHN4PyQvLCAnJykpfSc7XG5gO1xuICAgIHdyaXRlRmlsZUZyb21JbnB1dFBhdGgoaW5wdXRQYXRoLCBjb250ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgcGFja2FnZS5qc29uIGZvciBhIHNlY29uZGFyeSBlbnRyeS1wb2ludC5cbiAgICogQHBhcmFtIGRpciBUaGUgZGlyZWN0b3J5IHVuZGVyIHdoaWNoIHRoZSBwYWNrYWdlLmpzb24gc2hvdWxkIGJlIHdyaXR0ZW4uXG4gICAqIEBwYXJhbSBlbnRyeVBvaW50UGFja2FnZU5hbWUgVGhlIGZ1bGwgcGFja2FnZSBuYW1lIGZvciB0aGUgZW50cnkgcG9pbnQsXG4gICAqICAgICBlLmcuICdAYW5ndWxhci9jb21tb24vaHR0cCcuXG4gICAqL1xuICBmdW5jdGlvbiBjcmVhdGVFbnRyeVBvaW50UGFja2FnZUpzb24oZGlyOiBzdHJpbmcsIGVudHJ5UG9pbnRQYWNrYWdlTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgcGtnSnNvbiA9IHBhdGguam9pbihzcmNEaXIsIGRpciwgJ3BhY2thZ2UuanNvbicpO1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhbWVuZFBhY2thZ2VKc29uKHBrZ0pzb24sIHtuYW1lOiBlbnRyeVBvaW50UGFja2FnZU5hbWV9KTtcbiAgICB3cml0ZUZpbGVGcm9tSW5wdXRQYXRoKHBrZ0pzb24sIGNvbnRlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIE5vcm1hbGl6ZXMgdGhlIHNwZWNpZmllZCBwYXRoIGJ5IHJlcGxhY2luZyBiYWNrc2xhc2ggc2VwYXJhdG9ycyB3aXRoIFBvc2l4XG4gICAqIGZvcndhcmQgc2xhc2ggc2VwYXJhdG9ycy5cbiAgICovXG4gIGZ1bmN0aW9uIG5vcm1hbGl6ZVNlcGFyYXRvcnMocGF0aDogc3RyaW5nKTogc3RyaW5nIHsgcmV0dXJuIHBhdGgucmVwbGFjZSgvXFxcXC9nLCAnLycpOyB9XG59XG5cbmlmIChyZXF1aXJlLm1haW4gPT09IG1vZHVsZSkge1xuICBwcm9jZXNzLmV4aXRDb2RlID0gbWFpbihwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpO1xufVxuIl19