/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.dev/license
 */
import * as fs from 'fs';
import * as path from 'path';
import ts from 'typescript';
/** Comment that can be used to skip a single import from being flagged. */
const skipComment = '// @ng_package: ignore-cross-repo-import';
/**
 * Analyzes the given JavaScript source file and checks whether there are
 * any relative imports that point to different entry-points or packages.
 *
 * Such imports are flagged and will be returned in the failure list. Cross
 * entry-point or package imports result in duplicate code and therefore are
 * forbidden (unless explicitly opted out via comment - {@link skipComment}).
 */
export function analyzeFileAndEnsureNoCrossImports(file, pkg) {
    const content = fs.readFileSync(file.path, 'utf8');
    const sf = ts.createSourceFile(file.path, content, ts.ScriptTarget.Latest, true);
    const fileDirPath = path.posix.dirname(file.path);
    const fileDebugName = file.shortPath.replace(/\.[cm]js$/, '.ts');
    const failures = [];
    const owningPkg = determineOwningEntryPoint(file, pkg);
    if (owningPkg === null) {
        throw new Error(`Could not determine owning entry-point package of: ${file.shortPath}`);
    }
    // TODO: Consider handling deep dynamic import expressions.
    for (const st of sf.statements) {
        if ((!ts.isImportDeclaration(st) && !ts.isExportDeclaration(st)) ||
            st.moduleSpecifier === undefined ||
            !ts.isStringLiteralLike(st.moduleSpecifier)) {
            continue;
        }
        // Skip module imports.
        if (!st.moduleSpecifier.text.startsWith('.')) {
            continue;
        }
        // Skip this import if there is an explicit skip comment.
        const leadingComments = ts.getLeadingCommentRanges(sf.text, st.getFullStart());
        if (leadingComments !== undefined &&
            leadingComments.some((c) => sf.text.substring(c.pos, c.end) === skipComment)) {
            continue;
        }
        const destinationPath = path.posix.join(fileDirPath, st.moduleSpecifier.text);
        const targetPackage = determineOwningEntryPoint({ path: destinationPath }, pkg);
        if (targetPackage === null) {
            failures.push(`Could not determine owning entry-point package of: ${destinationPath}. Imported from: ${fileDebugName}. Is this a relative import to another full package?.\n` +
                `You can skip this import by adding a comment: ${skipComment}`);
            continue;
        }
    }
    return failures;
}
/** Determines the owning entry-point for the given JavaScript file. */
function determineOwningEntryPoint(file, pkg) {
    let owningEntryPoint = null;
    for (const [name, info] of Object.entries(pkg.entryPoints)) {
        // Entry point directory is assumed because technically the entry-point
        // could be deeper inside the entry-point source file package. This is
        // unlikely though and we still catch most cases, especially in the standard
        // folder layout where the APF entry-point index file resides at the top of
        // the entry-point.
        const assumedEntryPointDir = path.posix.dirname(info.index.path);
        if (file.path.startsWith(assumedEntryPointDir) &&
            (owningEntryPoint === null || owningEntryPoint.path.length < assumedEntryPointDir.length)) {
            owningEntryPoint = { name, info, path: assumedEntryPointDir };
        }
    }
    return owningEntryPoint;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3NfZW50cnlfcG9pbnRzX2ltcG9ydHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9iYXplbC9zcmMvbmdfcGFja2FnZS9jcm9zc19lbnRyeV9wb2ludHNfaW1wb3J0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFjNUIsMkVBQTJFO0FBQzNFLE1BQU0sV0FBVyxHQUFHLDBDQUEwQyxDQUFDO0FBRS9EOzs7Ozs7O0dBT0c7QUFDSCxNQUFNLFVBQVUsa0NBQWtDLENBQ2hELElBQW1CLEVBQ25CLEdBQW9CO0lBRXBCLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNuRCxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakYsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNqRSxNQUFNLFFBQVEsR0FBYSxFQUFFLENBQUM7SUFFOUIsTUFBTSxTQUFTLEdBQUcseUJBQXlCLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELElBQUksU0FBUyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsc0RBQXNELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQzFGLENBQUM7SUFFRCwyREFBMkQ7SUFDM0QsS0FBSyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDL0IsSUFDRSxDQUFDLENBQUMsRUFBRSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVELEVBQUUsQ0FBQyxlQUFlLEtBQUssU0FBUztZQUNoQyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLEVBQzNDLENBQUM7WUFDRCxTQUFTO1FBQ1gsQ0FBQztRQUNELHVCQUF1QjtRQUN2QixJQUFJLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDN0MsU0FBUztRQUNYLENBQUM7UUFDRCx5REFBeUQ7UUFDekQsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDLHVCQUF1QixDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7UUFDL0UsSUFDRSxlQUFlLEtBQUssU0FBUztZQUM3QixlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxXQUFXLENBQUMsRUFDNUUsQ0FBQztZQUNELFNBQVM7UUFDWCxDQUFDO1FBRUQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUUsTUFBTSxhQUFhLEdBQUcseUJBQXlCLENBQUMsRUFBQyxJQUFJLEVBQUUsZUFBZSxFQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDOUUsSUFBSSxhQUFhLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDM0IsUUFBUSxDQUFDLElBQUksQ0FDWCxzREFBc0QsZUFBZSxvQkFBb0IsYUFBYSx5REFBeUQ7Z0JBQzdKLGlEQUFpRCxXQUFXLEVBQUUsQ0FDakUsQ0FBQztZQUNGLFNBQVM7UUFDWCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUM7QUFFRCx1RUFBdUU7QUFDdkUsU0FBUyx5QkFBeUIsQ0FDaEMsSUFBaUMsRUFDakMsR0FBb0I7SUFFcEIsSUFBSSxnQkFBZ0IsR0FBNkIsSUFBSSxDQUFDO0lBRXRELEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDO1FBQzNELHVFQUF1RTtRQUN2RSxzRUFBc0U7UUFDdEUsNEVBQTRFO1FBQzVFLDJFQUEyRTtRQUMzRSxtQkFBbUI7UUFDbkIsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWpFLElBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUM7WUFDMUMsQ0FBQyxnQkFBZ0IsS0FBSyxJQUFJLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsRUFDekYsQ0FBQztZQUNELGdCQUFnQixHQUFHLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsb0JBQW9CLEVBQUMsQ0FBQztRQUM5RCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU8sZ0JBQWdCLENBQUM7QUFDMUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmRldi9saWNlbnNlXG4gKi9cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuaW1wb3J0IHtCYXplbEZpbGVJbmZvLCBFbnRyeVBvaW50SW5mbywgUGFja2FnZU1ldGFkYXRhfSBmcm9tICcuL2FwaSc7XG5cbi8qKiBJbnRlcmZhY2UgZGVzY3JpYmluZyBhbiBlbnRyeS1wb2ludCBCYXplbCBwYWNrYWdlLiAqL1xuaW50ZXJmYWNlIEVudHJ5UG9pbnRQYWNrYWdlIHtcbiAgLyoqIE1vZHVsZSBuYW1lIG9mIHRoZSBlbnRyeS1wb2ludC4gKi9cbiAgbmFtZTogc3RyaW5nO1xuICAvKiogRXhlY3Jvb3QtcmVsYXRpdmUgcGF0aCB0byB0aGUgZW50cnktcG9pbnQgcGFja2FnZS4gKi9cbiAgcGF0aDogc3RyaW5nO1xuICAvKiogRXh0cmFjdGVkIGluZm8gZm9yIHRoZSBlbnRyeS1wb2ludC4gKi9cbiAgaW5mbzogRW50cnlQb2ludEluZm87XG59XG5cbi8qKiBDb21tZW50IHRoYXQgY2FuIGJlIHVzZWQgdG8gc2tpcCBhIHNpbmdsZSBpbXBvcnQgZnJvbSBiZWluZyBmbGFnZ2VkLiAqL1xuY29uc3Qgc2tpcENvbW1lbnQgPSAnLy8gQG5nX3BhY2thZ2U6IGlnbm9yZS1jcm9zcy1yZXBvLWltcG9ydCc7XG5cbi8qKlxuICogQW5hbHl6ZXMgdGhlIGdpdmVuIEphdmFTY3JpcHQgc291cmNlIGZpbGUgYW5kIGNoZWNrcyB3aGV0aGVyIHRoZXJlIGFyZVxuICogYW55IHJlbGF0aXZlIGltcG9ydHMgdGhhdCBwb2ludCB0byBkaWZmZXJlbnQgZW50cnktcG9pbnRzIG9yIHBhY2thZ2VzLlxuICpcbiAqIFN1Y2ggaW1wb3J0cyBhcmUgZmxhZ2dlZCBhbmQgd2lsbCBiZSByZXR1cm5lZCBpbiB0aGUgZmFpbHVyZSBsaXN0LiBDcm9zc1xuICogZW50cnktcG9pbnQgb3IgcGFja2FnZSBpbXBvcnRzIHJlc3VsdCBpbiBkdXBsaWNhdGUgY29kZSBhbmQgdGhlcmVmb3JlIGFyZVxuICogZm9yYmlkZGVuICh1bmxlc3MgZXhwbGljaXRseSBvcHRlZCBvdXQgdmlhIGNvbW1lbnQgLSB7QGxpbmsgc2tpcENvbW1lbnR9KS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGFuYWx5emVGaWxlQW5kRW5zdXJlTm9Dcm9zc0ltcG9ydHMoXG4gIGZpbGU6IEJhemVsRmlsZUluZm8sXG4gIHBrZzogUGFja2FnZU1ldGFkYXRhLFxuKTogc3RyaW5nW10ge1xuICBjb25zdCBjb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGZpbGUucGF0aCwgJ3V0ZjgnKTtcbiAgY29uc3Qgc2YgPSB0cy5jcmVhdGVTb3VyY2VGaWxlKGZpbGUucGF0aCwgY29udGVudCwgdHMuU2NyaXB0VGFyZ2V0LkxhdGVzdCwgdHJ1ZSk7XG4gIGNvbnN0IGZpbGVEaXJQYXRoID0gcGF0aC5wb3NpeC5kaXJuYW1lKGZpbGUucGF0aCk7XG4gIGNvbnN0IGZpbGVEZWJ1Z05hbWUgPSBmaWxlLnNob3J0UGF0aC5yZXBsYWNlKC9cXC5bY21danMkLywgJy50cycpO1xuICBjb25zdCBmYWlsdXJlczogc3RyaW5nW10gPSBbXTtcblxuICBjb25zdCBvd25pbmdQa2cgPSBkZXRlcm1pbmVPd25pbmdFbnRyeVBvaW50KGZpbGUsIHBrZyk7XG4gIGlmIChvd25pbmdQa2cgPT09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBkZXRlcm1pbmUgb3duaW5nIGVudHJ5LXBvaW50IHBhY2thZ2Ugb2Y6ICR7ZmlsZS5zaG9ydFBhdGh9YCk7XG4gIH1cblxuICAvLyBUT0RPOiBDb25zaWRlciBoYW5kbGluZyBkZWVwIGR5bmFtaWMgaW1wb3J0IGV4cHJlc3Npb25zLlxuICBmb3IgKGNvbnN0IHN0IG9mIHNmLnN0YXRlbWVudHMpIHtcbiAgICBpZiAoXG4gICAgICAoIXRzLmlzSW1wb3J0RGVjbGFyYXRpb24oc3QpICYmICF0cy5pc0V4cG9ydERlY2xhcmF0aW9uKHN0KSkgfHxcbiAgICAgIHN0Lm1vZHVsZVNwZWNpZmllciA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICAhdHMuaXNTdHJpbmdMaXRlcmFsTGlrZShzdC5tb2R1bGVTcGVjaWZpZXIpXG4gICAgKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgLy8gU2tpcCBtb2R1bGUgaW1wb3J0cy5cbiAgICBpZiAoIXN0Lm1vZHVsZVNwZWNpZmllci50ZXh0LnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIC8vIFNraXAgdGhpcyBpbXBvcnQgaWYgdGhlcmUgaXMgYW4gZXhwbGljaXQgc2tpcCBjb21tZW50LlxuICAgIGNvbnN0IGxlYWRpbmdDb21tZW50cyA9IHRzLmdldExlYWRpbmdDb21tZW50UmFuZ2VzKHNmLnRleHQsIHN0LmdldEZ1bGxTdGFydCgpKTtcbiAgICBpZiAoXG4gICAgICBsZWFkaW5nQ29tbWVudHMgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgbGVhZGluZ0NvbW1lbnRzLnNvbWUoKGMpID0+IHNmLnRleHQuc3Vic3RyaW5nKGMucG9zLCBjLmVuZCkgPT09IHNraXBDb21tZW50KVxuICAgICkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29uc3QgZGVzdGluYXRpb25QYXRoID0gcGF0aC5wb3NpeC5qb2luKGZpbGVEaXJQYXRoLCBzdC5tb2R1bGVTcGVjaWZpZXIudGV4dCk7XG4gICAgY29uc3QgdGFyZ2V0UGFja2FnZSA9IGRldGVybWluZU93bmluZ0VudHJ5UG9pbnQoe3BhdGg6IGRlc3RpbmF0aW9uUGF0aH0sIHBrZyk7XG4gICAgaWYgKHRhcmdldFBhY2thZ2UgPT09IG51bGwpIHtcbiAgICAgIGZhaWx1cmVzLnB1c2goXG4gICAgICAgIGBDb3VsZCBub3QgZGV0ZXJtaW5lIG93bmluZyBlbnRyeS1wb2ludCBwYWNrYWdlIG9mOiAke2Rlc3RpbmF0aW9uUGF0aH0uIEltcG9ydGVkIGZyb206ICR7ZmlsZURlYnVnTmFtZX0uIElzIHRoaXMgYSByZWxhdGl2ZSBpbXBvcnQgdG8gYW5vdGhlciBmdWxsIHBhY2thZ2U/LlxcbmAgK1xuICAgICAgICAgIGBZb3UgY2FuIHNraXAgdGhpcyBpbXBvcnQgYnkgYWRkaW5nIGEgY29tbWVudDogJHtza2lwQ29tbWVudH1gLFxuICAgICAgKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWlsdXJlcztcbn1cblxuLyoqIERldGVybWluZXMgdGhlIG93bmluZyBlbnRyeS1wb2ludCBmb3IgdGhlIGdpdmVuIEphdmFTY3JpcHQgZmlsZS4gKi9cbmZ1bmN0aW9uIGRldGVybWluZU93bmluZ0VudHJ5UG9pbnQoXG4gIGZpbGU6IFBpY2s8QmF6ZWxGaWxlSW5mbywgJ3BhdGgnPixcbiAgcGtnOiBQYWNrYWdlTWV0YWRhdGEsXG4pOiBFbnRyeVBvaW50UGFja2FnZSB8IG51bGwge1xuICBsZXQgb3duaW5nRW50cnlQb2ludDogRW50cnlQb2ludFBhY2thZ2UgfCBudWxsID0gbnVsbDtcblxuICBmb3IgKGNvbnN0IFtuYW1lLCBpbmZvXSBvZiBPYmplY3QuZW50cmllcyhwa2cuZW50cnlQb2ludHMpKSB7XG4gICAgLy8gRW50cnkgcG9pbnQgZGlyZWN0b3J5IGlzIGFzc3VtZWQgYmVjYXVzZSB0ZWNobmljYWxseSB0aGUgZW50cnktcG9pbnRcbiAgICAvLyBjb3VsZCBiZSBkZWVwZXIgaW5zaWRlIHRoZSBlbnRyeS1wb2ludCBzb3VyY2UgZmlsZSBwYWNrYWdlLiBUaGlzIGlzXG4gICAgLy8gdW5saWtlbHkgdGhvdWdoIGFuZCB3ZSBzdGlsbCBjYXRjaCBtb3N0IGNhc2VzLCBlc3BlY2lhbGx5IGluIHRoZSBzdGFuZGFyZFxuICAgIC8vIGZvbGRlciBsYXlvdXQgd2hlcmUgdGhlIEFQRiBlbnRyeS1wb2ludCBpbmRleCBmaWxlIHJlc2lkZXMgYXQgdGhlIHRvcCBvZlxuICAgIC8vIHRoZSBlbnRyeS1wb2ludC5cbiAgICBjb25zdCBhc3N1bWVkRW50cnlQb2ludERpciA9IHBhdGgucG9zaXguZGlybmFtZShpbmZvLmluZGV4LnBhdGgpO1xuXG4gICAgaWYgKFxuICAgICAgZmlsZS5wYXRoLnN0YXJ0c1dpdGgoYXNzdW1lZEVudHJ5UG9pbnREaXIpICYmXG4gICAgICAob3duaW5nRW50cnlQb2ludCA9PT0gbnVsbCB8fCBvd25pbmdFbnRyeVBvaW50LnBhdGgubGVuZ3RoIDwgYXNzdW1lZEVudHJ5UG9pbnREaXIubGVuZ3RoKVxuICAgICkge1xuICAgICAgb3duaW5nRW50cnlQb2ludCA9IHtuYW1lLCBpbmZvLCBwYXRoOiBhc3N1bWVkRW50cnlQb2ludERpcn07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG93bmluZ0VudHJ5UG9pbnQ7XG59XG4iXX0=